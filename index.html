<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ Job Tracker â€” Nemesis</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    --bg: #0f1117;
    --bg2: #1a1d27;
    --bg3: #242836;
    --border: #2e3348;
    --text: #e4e4e7;
    --text2: #9ca3af;
    --accent: #6366f1;
    --accent2: #818cf8;
    --green: #22c55e;
    --yellow: #eab308;
    --orange: #f97316;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
    --pink: #ec4899;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .header h1 span { font-size: 1.8rem; }
  .header-actions { display: flex; gap: 10px; }
  
  /* STATS BAR */
  .stats-bar {
    display: flex;
    gap: 16px;
    padding: 20px 32px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 24px;
    min-width: 140px;
    flex: 1;
    text-align: center;
    transition: transform 0.2s, border-color 0.2s;
    cursor: default;
  }
  .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
  .stat-number { font-size: 2rem; font-weight: 700; }
  .stat-label { font-size: 0.75rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
  
  /* FILTERS */
  .filters-bar {
    padding: 0 32px 16px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .search-input {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    color: var(--text);
    font-size: 0.85rem;
    width: 250px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text2); }
  
  .filter-btn {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    color: var(--text2);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover, .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

  /* BUTTONS */
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-small { padding: 5px 10px; font-size: 0.75rem; }
  .btn-icon { padding: 6px 8px; font-size: 0.9rem; }

  /* TABLE */
  .table-container {
    padding: 0 32px 32px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg2);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  thead { background: var(--bg3); }
  th {
    padding: 12px 16px;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  th:hover { color: var(--accent2); }
  td {
    padding: 12px 16px;
    font-size: 0.85rem;
    border-top: 1px solid var(--border);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  tr:hover td { background: rgba(99, 102, 241, 0.05); }

  /* STATUS BADGES */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .badge-envoyee { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-relancee { background: rgba(249,115,22,0.15); color: var(--orange); }
  .badge-entretien { background: rgba(168,85,247,0.15); color: var(--purple); }
  .badge-offre { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-refus { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge-ghosted { background: rgba(156,163,175,0.15); color: var(--text2); }
  .badge-brouillon { background: rgba(234,179,8,0.15); color: var(--yellow); }

  /* RELANCE INDICATOR */
  .relance-due { color: var(--red); font-weight: 600; }
  .relance-soon { color: var(--orange); font-weight: 500; }
  .relance-ok { color: var(--text2); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 560px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal h2 { font-size: 1.2rem; margin-bottom: 24px; }
  .form-group { margin-bottom: 16px; }
  .form-group label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 0.85rem;
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); }
  .form-group textarea { min-height: 80px; resize: vertical; }
  .form-row { display: flex; gap: 16px; }
  .form-row .form-group { flex: 1; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text2);
  }
  .empty-state .emoji { font-size: 3rem; margin-bottom: 16px; }
  .empty-state p { font-size: 0.9rem; margin-bottom: 20px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--green);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 2000;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ACTIONS CELL */
  .actions-cell { display: flex; gap: 4px; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .header { padding: 16px; }
    .stats-bar { padding: 16px; }
    .filters-bar { padding: 0 16px 16px; }
    .table-container { padding: 0 16px 16px; }
    .stat-card { min-width: 100px; padding: 12px 16px; }
    .stat-number { font-size: 1.5rem; }
  }

  /* TIMELINE inside modal */
  .timeline { margin-top: 16px; }
  .timeline-item {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-left: 2px solid var(--border);
    padding-left: 16px;
    margin-left: 8px;
    position: relative;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 14px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
  }
  .timeline-date { font-size: 0.72rem; color: var(--text2); min-width: 80px; }
  .timeline-text { font-size: 0.8rem; color: var(--text); }

  select option { background: var(--bg); color: var(--text); }

  /* TABS */
  .tabs {
    display: flex;
    gap: 0;
    padding: 0 32px;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
  }
  .tab {
    padding: 14px 24px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent2); border-bottom-color: var(--accent); }
  .tab .tab-count {
    background: var(--bg3);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  .tab.active .tab-count { background: rgba(99,102,241,0.2); color: var(--accent2); }
  .section { display: none; }
  .section.active { display: block; }

  /* ESN CARDS */
  .esn-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 16px;
    padding: 20px 32px;
  }
  .esn-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s;
    cursor: pointer;
  }
  .esn-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .esn-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .esn-card-header h3 {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .esn-card-header .esn-priority {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .priority-hot { background: rgba(239,68,68,0.15); color: var(--red); }
  .priority-warm { background: rgba(249,115,22,0.15); color: var(--orange); }
  .priority-cold { background: rgba(156,163,175,0.15); color: var(--text2); }
  .priority-new { background: rgba(59,130,246,0.15); color: var(--blue); }

  .esn-contacts {
    margin: 12px 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .esn-contact {
    background: var(--bg);
    border-radius: 8px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .esn-contact-name {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
  }
  .esn-contact-role {
    font-size: 0.72rem;
    color: var(--text2);
  }
  .esn-contact-channels {
    display: flex;
    gap: 8px;
    margin-top: 4px;
    flex-wrap: wrap;
  }
  .esn-contact-channels a, .esn-contact-channels span {
    font-size: 0.72rem;
    color: var(--accent2);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .esn-contact-channels a:hover { text-decoration: underline; }

  .esn-contact-linked {
    background: var(--bg);
    border-radius: 8px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-left: 3px solid var(--accent);
    cursor: pointer;
    transition: background 0.15s;
  }
  .esn-contact-linked:hover { background: var(--bg2); }
  .esn-contact-linked .rh-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.65rem;
    color: var(--accent2);
    background: rgba(99,102,241,0.15);
    padding: 1px 7px;
    border-radius: 10px;
    margin-left: 6px;
  }
  .rh-autocomplete-container { position: relative; margin-bottom: 10px; }
  .rh-autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
  }
  .rh-autocomplete-dropdown.visible { display: block; }
  .rh-autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.82rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .rh-autocomplete-item:hover { background: var(--bg3); }
  .rh-autocomplete-item .rh-item-company { font-size: 0.72rem; color: var(--text2); }
  .esn-linked-ref {
    background: rgba(99,102,241,0.08);
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .esn-linked-ref-info { font-size: 0.82rem; }
  .esn-linked-ref-info .ref-role { font-size: 0.72rem; color: var(--text2); }

  .esn-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .esn-meta-item {
    font-size: 0.72rem;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .esn-candidatures-count {
    font-size: 0.72rem;
    color: var(--accent2);
    margin-top: 8px;
  }
  .esn-notes {
    font-size: 0.8rem;
    color: var(--text2);
    margin-top: 8px;
    line-height: 1.4;
  }

  .esn-stats-bar {
    display: flex;
    gap: 16px;
    padding: 20px 32px 0;
    flex-wrap: wrap;
  }

  .esn-filters {
    padding: 16px 32px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  @media (max-width: 768px) {
    .tabs { padding: 0 16px; }
    .esn-grid { padding: 16px; grid-template-columns: 1fr; }
    .esn-stats-bar { padding: 16px 16px 0; }
    .esn-filters { padding: 12px 16px 0; }
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>ğŸ˜ˆ</span> Job Tracker</h1>
  <div class="header-actions">
    <button class="btn btn-secondary" onclick="hunterQuota()" title="Voir quota Hunter.io">ğŸ” Quota</button>
    <button class="btn btn-secondary" onclick="connectFile()" id="connectBtn">ğŸ”— Connecter fichier</button>
    <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ Exporter</button>
    <button class="btn btn-secondary" onclick="importData()">ğŸ“¥ Importer</button>
    <button class="btn btn-primary" onclick="openModal()">+ Candidature</button>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('candidatures', this)">ğŸ¯ Candidatures <span class="tab-count" id="tabCountCandidatures">0</span></div>
  <div class="tab" onclick="switchTab('esn', this)">ğŸ¢ RÃ©seau Pro <span class="tab-count" id="tabCountEsn">0</span></div>
  <div class="tab" onclick="switchTab('contacts', this)">ğŸ‘¥ Contacts RH <span class="tab-count" id="tabCountContacts">0</span></div>
</div>

<!-- SECTION CANDIDATURES -->
<div class="section active" id="section-candidatures">

<div class="stats-bar" id="stats-bar"></div>

<div class="filters-bar">
  <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” Rechercher entreprise, poste, contact..." oninput="renderTable()">
  <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">Tout</button>
  <button class="filter-btn" data-filter="envoyee" onclick="setFilter('envoyee', this)">ğŸ“¨ EnvoyÃ©es</button>
  <button class="filter-btn" data-filter="relancee" onclick="setFilter('relancee', this)">ğŸ”„ RelancÃ©es</button>
  <button class="filter-btn" data-filter="entretien" onclick="setFilter('entretien', this)">ğŸ“ Entretiens</button>
  <button class="filter-btn" data-filter="offre" onclick="setFilter('offre', this)">âœ… Offres</button>
  <button class="filter-btn" data-filter="refus" onclick="setFilter('refus', this)">âŒ Refus</button>
  <button class="filter-btn" data-filter="ghosted" onclick="setFilter('ghosted', this)">ğŸ‘» Ghosted</button>
  <button class="filter-btn" data-filter="relance-due" onclick="setFilter('relance-due', this)">ğŸ”´ Relance Ã  faire</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th onclick="sortBy('date')">Date â†•</th>
        <th onclick="sortBy('entreprise')">Entreprise â†•</th>
        <th onclick="sortBy('poste')">Poste â†•</th>
        <th onclick="sortBy('contact')">Contact</th>
        <th onclick="sortBy('source')">Source</th>
        <th onclick="sortBy('statut')">Statut</th>
        <th onclick="sortBy('relanceDate')">Relance</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="empty-state" id="emptyState" style="display:none;">
    <div class="emoji">ğŸ¯</div>
    <p>Aucune candidature pour l'instant.<br>Clique sur <strong>+ Candidature</strong> pour commencer.</p>
  </div>
</div>

</div><!-- /section-candidatures -->

<!-- SECTION ESN -->
<div class="section" id="section-esn">
  <div class="esn-stats-bar" id="esn-stats-bar"></div>
  <div class="esn-filters">
    <input type="text" class="search-input" id="esnSearchInput" placeholder="ğŸ” Rechercher ESN, contact, ville..." oninput="renderEsnGrid()">
    <button class="filter-btn active" data-esn-filter="all" onclick="setEsnFilter('all', this)">Tous</button>
    <button class="filter-btn" data-esn-filter="type-esn" onclick="setEsnFilter('type-esn', this)">ğŸ¢ ESN</button>
    <button class="filter-btn" data-esn-filter="type-cabinet" onclick="setEsnFilter('type-cabinet', this)">ğŸ¯ Cabinets</button>
    <button class="filter-btn" data-esn-filter="type-interim" onclick="setEsnFilter('type-interim', this)">â³ IntÃ©rim IT</button>
    <span style="color:var(--border)">â”‚</span>
    <button class="filter-btn" data-esn-filter="hot" onclick="setEsnFilter('hot', this)">ğŸ”´ Hot</button>
    <button class="filter-btn" data-esn-filter="warm" onclick="setEsnFilter('warm', this)">ğŸŸ  Warm</button>
    <button class="filter-btn" data-esn-filter="new" onclick="setEsnFilter('new', this)">ğŸ”µ Nouveau</button>
    <button class="filter-btn" data-esn-filter="cold" onclick="setEsnFilter('cold', this)">âšª Cold</button>
    <div style="flex:1"></div>
    <button class="btn btn-primary" onclick="openEsnModal()">+ Ajouter</button>
  </div>
  <div class="esn-grid" id="esnGrid"></div>
  <div class="empty-state" id="esnEmptyState" style="display:none;">
    <div class="emoji">ğŸ¢</div>
    <p>Aucune entrÃ©e.<br>Clique sur <strong>+ Ajouter</strong> pour rÃ©fÃ©rencer une ESN ou un cabinet.</p>
  </div>
</div>

<!-- SECTION CONTACTS RH -->
<div class="section" id="section-contacts">
  <div class="esn-stats-bar" id="contacts-stats-bar"></div>
  <div class="esn-filters">
    <input type="text" class="search-input" id="contactsSearchInput" placeholder="ğŸ” Rechercher contact, entreprise, rÃ´le..." oninput="renderContactsGrid()">
    <button class="filter-btn active" data-contacts-filter="all" onclick="setContactsFilter('all', this)">Tous</button>
    <button class="filter-btn" data-contacts-filter="status-a-contacter" onclick="setContactsFilter('status-a-contacter', this)">ğŸ“§ Ã€ contacter</button>
    <button class="filter-btn" data-contacts-filter="status-contacte" onclick="setContactsFilter('status-contacte', this)">âœ… ContactÃ©</button>
    <button class="filter-btn" data-contacts-filter="status-rdv" onclick="setContactsFilter('status-rdv', this)">ğŸ“… RDV programmÃ©</button>
    <button class="filter-btn" data-contacts-filter="status-suivi" onclick="setContactsFilter('status-suivi', this)">ğŸ”„ En suivi</button>
    <button class="filter-btn" data-contacts-filter="status-dead" onclick="setContactsFilter('status-dead', this)">ğŸ’€ Dead</button>
    <span style="color:var(--border)">â”‚</span>
    <button class="filter-btn" data-contacts-filter="priorite-urgent" onclick="setContactsFilter('priorite-urgent', this)">ğŸ”´ Urgent</button>
    <button class="filter-btn" data-contacts-filter="priorite-important" onclick="setContactsFilter('priorite-important', this)">ğŸŸ  Important</button>
    <button class="filter-btn" data-contacts-filter="priorite-normal" onclick="setContactsFilter('priorite-normal', this)">ğŸŸ¡ Normal</button>
    <div style="flex:1"></div>
    <button class="btn btn-primary" onclick="openContactModal()">+ Ajouter Contact</button>
  </div>
  <div class="esn-grid" id="contactsGrid"></div>
  <div class="empty-state" id="contactsEmptyState" style="display:none;">
    <div class="emoji">ğŸ‘¥</div>
    <p>Aucun contact RH.<br>Clique sur <strong>+ Ajouter Contact</strong> pour commencer Ã  constituer ton rÃ©seau.</p>
  </div>
</div>

<!-- MODAL ESN -->
<div class="modal-overlay" id="esnModal">
  <div class="modal">
    <h2 id="esnModalTitle">Nouvelle ESN</h2>
    <input type="hidden" id="esnEditId">

    <div class="form-group">
      <label>Nom *</label>
      <input type="text" id="esnNom" placeholder="Ex: Helpline, Michael Page, Randstad Digital...">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Type</label>
        <select id="esnType">
          <option value="esn">ğŸ¢ ESN / SSII</option>
          <option value="cabinet">ğŸ¯ Cabinet de recrutement</option>
          <option value="interim">â³ IntÃ©rim IT</option>
        </select>
      </div>
      <div class="form-group">
        <label>PrioritÃ©</label>
        <select id="esnPriorite">
          <option value="new">ğŸ”µ Nouveau</option>
          <option value="hot">ğŸ”´ Hot â€” contact direct identifiÃ©</option>
          <option value="warm">ğŸŸ  Warm â€” en cours d'approche</option>
          <option value="cold">âšª Cold â€” juste repÃ©rÃ©e</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Site web</label>
        <input type="url" id="esnSite" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Page recrutement / CarriÃ¨res</label>
        <input type="url" id="esnCarrieres" placeholder="https://...careers...">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Ville(s) / Agence</label>
        <input type="text" id="esnVille" placeholder="Ex: Lille, Marcq-en-BarÅ“ul...">
      </div>
      <div class="form-group">
        <label>SpÃ©cialitÃ©s</label>
        <input type="text" id="esnSpecialites" placeholder="Ex: InfogÃ©rance, Support, Cloud...">
      </div>
    </div>

    <div class="form-group">
      <label>LinkedIn page entreprise</label>
      <input type="url" id="esnLinkedin" placeholder="https://linkedin.com/company/...">
    </div>

    <!-- CONTACTS -->
    <div style="margin-top:20px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
      <label style="font-size:0.75rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;">Contacts recrutement</label>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-small btn-secondary" onclick="const id=document.getElementById('esnEditId').value; if(id) hunterSearch(id);" title="Chercher via Hunter.io">ğŸ” Hunter</button>
        <button class="btn btn-small btn-secondary" onclick="showLinkContactRH()" title="Lier un contact RH existant">ğŸ”— Lier contact RH</button>
        <button class="btn btn-small btn-secondary" onclick="addContactField()">+ Contact</button>
      </div>
    </div>

    <!-- Contacts RH liÃ©s -->
    <div id="esnLinkedContactsList"></div>

    <!-- Autocomplete recherche contact RH -->
    <div id="esnLinkContactContainer" class="rh-autocomplete-container" style="display:none;">
      <input type="text" id="esnLinkContactSearch" class="search-input" style="width:100%;" placeholder="Chercher un contact RH par nom, entreprise..." oninput="filterContactRHAutocomplete(this.value)" onfocus="filterContactRHAutocomplete(this.value)">
      <div id="esnLinkContactDropdown" class="rh-autocomplete-dropdown"></div>
    </div>

    <!-- Contacts inline -->
    <div id="esnContactsList"></div>

    <div class="form-group" style="margin-top:16px">
      <label>Notes / StratÃ©gie d'approche</label>
      <textarea id="esnNotes" placeholder="Comment les approcher, quand relancer, infos utiles..."></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeEsnModal()">Annuler</button>
      <button class="btn btn-danger btn-small" id="esnDeleteBtn" onclick="deleteEsn()" style="display:none;">ğŸ—‘ï¸ Supprimer</button>
      <button class="btn btn-primary" onclick="saveEsn()">ğŸ’¾ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- MODAL CONTACT RH -->
<div class="modal-overlay" id="contactModal">
  <div class="modal" style="max-width: 700px;">
    <h2 id="contactModalTitle">Nouveau Contact RH</h2>
    <input type="hidden" id="contactEditId">

    <div class="form-row">
      <div class="form-group">
        <label>Nom du contact *</label>
        <input type="text" id="contactNom" placeholder="Ex: Isabelle NÃ©ri, Bruno Vincent...">
      </div>
      <div class="form-group">
        <label>Poste / RÃ´le</label>
        <input type="text" id="contactRole" placeholder="Ex: IT Recruiter, CEO, HR Business Partner...">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Entreprise *</label>
        <input type="text" id="contactEntreprise" placeholder="Ex: HELPLINE, OVHcloud, Econocom...">
      </div>
      <div class="form-group">
        <label>Ville</label>
        <input type="text" id="contactVille" placeholder="Ex: Lille, Marcq-en-BarÅ“ul...">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="contactEmail" placeholder="prenom.nom@entreprise.com">
      </div>
      <div class="form-group">
        <label>TÃ©lÃ©phone</label>
        <input type="tel" id="contactTelephone" placeholder="+33 X XX XX XX XX">
      </div>
    </div>

    <div class="form-group">
      <label>LinkedIn du contact</label>
      <input type="url" id="contactLinkedin" placeholder="https://linkedin.com/in/...">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Statut</label>
        <select id="contactStatut">
          <option value="a-contacter">ğŸ“§ Ã€ contacter</option>
          <option value="contacte">âœ… ContactÃ©</option>
          <option value="rdv">ğŸ“… RDV programmÃ©</option>
          <option value="suivi">ğŸ”„ En suivi</option>
          <option value="dead">ğŸ’€ Dead</option>
        </select>
      </div>
      <div class="form-group">
        <label>PrioritÃ©</label>
        <select id="contactPriorite">
          <option value="urgent">ğŸ”´ Urgent â€” rÃ©pondu ou contact direct</option>
          <option value="important">ğŸŸ  Important â€” bonne cible identifiÃ©e</option>
          <option value="normal">ğŸŸ¡ Normal â€” prospect standard</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Source de dÃ©couverte</label>
      <input type="text" id="contactSource" placeholder="Ex: Hunter.io, LinkedIn, recommandation...">
    </div>

    <div class="form-group">
      <label>Notes / Contexte</label>
      <textarea id="contactNotes" placeholder="Comment tu l'as trouvÃ©, ce qu'il faut retenir, stratÃ©gie d'approche..."></textarea>
    </div>

    <!-- OBJECTIFS -->
    <div style="margin-top:20px; margin-bottom:12px;">
      <label style="font-size:0.75rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;">ğŸ¯ Objectifs & Actions</label>
    </div>
    <div id="objectifsList"></div>
    <button class="btn btn-small btn-secondary" onclick="addObjectifField()" style="margin-bottom: 16px;">+ Ajouter objectif</button>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeContactModal()">Annuler</button>
      <button class="btn btn-danger btn-small" id="contactDeleteBtn" onclick="deleteContact()" style="display:none;">ğŸ—‘ï¸ Supprimer</button>
      <button class="btn btn-primary" onclick="saveContact()">ğŸ’¾ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- MODAL ADD/EDIT -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2 id="modalTitle">Nouvelle candidature</h2>
    <input type="hidden" id="editId">
    
    <div class="form-row">
      <div class="form-group">
        <label>Entreprise *</label>
        <input type="text" id="fEntreprise" placeholder="Ex: OVH, Decathlon IT..." required>
      </div>
      <div class="form-group">
        <label>Poste *</label>
        <input type="text" id="fPoste" placeholder="Ex: Technicien Helpdesk N2">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Contact / Recruteur</label>
        <input type="text" id="fContact" placeholder="Nom, email, tel...">
      </div>
      <div class="form-group">
        <label>Source</label>
        <select id="fSource">
          <option value="Indeed">Indeed</option>
          <option value="LinkedIn">LinkedIn</option>
          <option value="HelloWork">HelloWork</option>
          <option value="France Travail">France Travail</option>
          <option value="Site entreprise">Site entreprise</option>
          <option value="Cooptation">Cooptation</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Date candidature</label>
        <input type="date" id="fDate">
      </div>
      <div class="form-group">
        <label>Statut</label>
        <select id="fStatut">
          <option value="brouillon">ğŸ“ Brouillon</option>
          <option value="envoyee">ğŸ“¨ EnvoyÃ©e</option>
          <option value="relancee">ğŸ”„ RelancÃ©e</option>
          <option value="entretien">ğŸ“ Entretien</option>
          <option value="offre">âœ… Offre</option>
          <option value="refus">âŒ Refus</option>
          <option value="ghosted">ğŸ‘» Ghosted</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Date relance prÃ©vue</label>
        <input type="date" id="fRelanceDate">
      </div>
      <div class="form-group">
        <label>Lieu / Ville</label>
        <input type="text" id="fLieu" placeholder="Ex: Lille, Remote...">
      </div>
    </div>

    <div class="form-group">
      <label>Lien offre</label>
      <input type="url" id="fUrl" placeholder="https://...">
    </div>

    <div class="form-group">
      <label>Salaire proposÃ©</label>
      <input type="text" id="fSalaire" placeholder="Ex: 25-30K, SMIC+, Ã  nÃ©gocier...">
    </div>

    <div class="form-group">
      <label>Notes</label>
      <textarea id="fNotes" placeholder="DÃ©tails, impressions, retours..."></textarea>
    </div>

    <div id="timelineContainer"></div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn btn-danger btn-small" id="deleteBtn" onclick="deleteEntry()" style="display:none;">ğŸ—‘ï¸ Supprimer</button>
      <button class="btn btn-primary" onclick="saveEntry()">ğŸ’¾ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// DATA â€” persistent via File System Access API (data.json)
let data = [];
let fileHandle = null;
let currentFilter = 'all';
let currentSort = { field: 'date', dir: 'desc' };

// Save to file + localStorage backup
async function save() {
  localStorage.setItem('jobtracker', JSON.stringify(data));
  if (fileHandle) {
    try {
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
    } catch(e) { console.warn('File save failed, localStorage OK:', e); }
  }
  renderStats();
  renderTable();
}

// Load from data.json (same directory as tracker.html)
async function initData() {
  // Try loading data.json from same folder
  try {
    const resp = await fetch('data.json');
    if (resp.ok) {
      const fileData = JSON.parse(await resp.text());
      if (Array.isArray(fileData) && fileData.length > 0) {
        data = fileData;
        // Also sync to localStorage
        localStorage.setItem('jobtracker', JSON.stringify(data));
        renderStats();
        renderTable();
        toast('ğŸ“‚ DonnÃ©es chargÃ©es depuis data.json');
        return;
      }
    }
  } catch(e) { console.log('No data.json fetch, trying localStorage'); }

  // Force reload from SEED_DATA to apply updates
  data = SEED_DATA;
  save();
  renderStats();
  renderTable();
}

// Connect to file for persistent writes
async function connectFile() {
  if (!window.showOpenFilePicker) {
    toast('âš ï¸ File System API non supportÃ©e â€” utilise Chrome/Edge', 'var(--orange)');
    return;
  }
  try {
    const [handle] = await window.showOpenFilePicker({
      types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
      startIn: 'documents'
    });
    fileHandle = handle;
    // Store handle for session persistence
    if ('indexedDB' in window) {
      const db = await openHandleDB();
      const tx = db.transaction('handles', 'readwrite');
      tx.objectStore('handles').put(handle, 'jobtracker');
      await tx.done;
    }
    // Read from connected file
    const file = await handle.getFile();
    const content = JSON.parse(await file.text());
    if (Array.isArray(content)) {
      data = content;
      localStorage.setItem('jobtracker', JSON.stringify(data));
      renderStats();
      renderTable();
    }
    toast('âœ… Fichier connectÃ© â€” sauvegarde auto activÃ©e');
  } catch(e) {
    if (e.name !== 'AbortError') toast('âŒ Erreur connexion fichier', 'var(--red)');
  }
}

// Restore file handle from IndexedDB on page load
async function restoreFileHandle() {
  if (!('indexedDB' in window)) return;
  try {
    const db = await openHandleDB();
    const tx = db.transaction('handles', 'readonly');
    const handle = await tx.objectStore('handles').get('jobtracker');
    if (handle) {
      const perm = await handle.queryPermission({ mode: 'readwrite' });
      if (perm === 'granted') {
        fileHandle = handle;
        // Read latest from file
        const file = await handle.getFile();
        const content = JSON.parse(await file.text());
        if (Array.isArray(content) && content.length > 0) {
          data = content;
          localStorage.setItem('jobtracker', JSON.stringify(data));
          renderStats();
          renderTable();
        }
        toast('ğŸ“‚ Fichier reconnectÃ© automatiquement');
      } else {
        // Need to re-request permission
        const req = await handle.requestPermission({ mode: 'readwrite' });
        if (req === 'granted') {
          fileHandle = handle;
          toast('ğŸ“‚ Fichier reconnectÃ©');
        }
      }
    }
  } catch(e) { console.log('No stored file handle'); }
}

function openHandleDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('JobTrackerHandles', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('handles');
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

// STATS
function renderStats() {
  const total = data.length;
  const counts = { envoyee: 0, relancee: 0, entretien: 0, offre: 0, refus: 0, ghosted: 0, brouillon: 0 };
  const relanceDue = data.filter(d => isRelanceDue(d)).length;
  
  data.forEach(d => { if (counts[d.statut] !== undefined) counts[d.statut]++; });

  const active = total - counts.refus - counts.ghosted;
  const tauxReponse = total > 0 ? Math.round(((counts.entretien + counts.offre + counts.refus) / total) * 100) : 0;

  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-number">${total}</div><div class="stat-label">Total</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--blue)">${counts.envoyee}</div><div class="stat-label">En attente</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--orange)">${counts.relancee}</div><div class="stat-label">RelancÃ©es</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--purple)">${counts.entretien}</div><div class="stat-label">Entretiens</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--green)">${counts.offre}</div><div class="stat-label">Offres</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--red)">${relanceDue}</div><div class="stat-label">ğŸ”´ Relances</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--yellow)">${tauxReponse}%</div><div class="stat-label">Taux rÃ©ponse</div></div>
  `;
  if (typeof updateTabCounts === 'function') updateTabCounts();
}

function isRelanceDue(entry) {
  if (!entry.relanceDate || entry.statut === 'offre' || entry.statut === 'refus' || entry.statut === 'ghosted') return false;
  return new Date(entry.relanceDate) <= new Date();
}

function isRelanceSoon(entry) {
  if (!entry.relanceDate || entry.statut === 'offre' || entry.statut === 'refus' || entry.statut === 'ghosted') return false;
  const diff = (new Date(entry.relanceDate) - new Date()) / (1000*60*60*24);
  return diff > 0 && diff <= 3;
}

// TABLE
function renderTable() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  let filtered = data.filter(d => {
    if (currentFilter === 'relance-due') return isRelanceDue(d);
    if (currentFilter !== 'all' && d.statut !== currentFilter) return false;
    if (query) {
      const hay = `${d.entreprise} ${d.poste} ${d.contact} ${d.lieu} ${d.notes} ${d.source}`.toLowerCase();
      if (!hay.includes(query)) return false;
    }
    return true;
  });

  filtered.sort((a, b) => {
    let va = a[currentSort.field] || '', vb = b[currentSort.field] || '';
    if (currentSort.field === 'date' || currentSort.field === 'relanceDate') {
      va = va || '0000'; vb = vb || '0000';
    }
    const cmp = va < vb ? -1 : va > vb ? 1 : 0;
    return currentSort.dir === 'asc' ? cmp : -cmp;
  });

  const tbody = document.getElementById('tableBody');
  const empty = document.getElementById('emptyState');

  if (filtered.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = filtered.map(d => {
    const badgeClass = `badge-${d.statut}`;
    const statutLabels = { brouillon:'ğŸ“ Brouillon', envoyee:'ğŸ“¨ EnvoyÃ©e', relancee:'ğŸ”„ RelancÃ©e', entretien:'ğŸ“ Entretien', offre:'âœ… Offre', refus:'âŒ Refus', ghosted:'ğŸ‘» Ghosted' };
    
    let relanceHtml = 'â€”';
    if (d.relanceDate) {
      const cls = isRelanceDue(d) ? 'relance-due' : isRelanceSoon(d) ? 'relance-soon' : 'relance-ok';
      const label = isRelanceDue(d) ? 'ğŸ”´ ' : isRelanceSoon(d) ? 'ğŸŸ¡ ' : '';
      relanceHtml = `<span class="${cls}">${label}${formatDate(d.relanceDate)}</span>`;
    }

    return `<tr ondblclick="openModal('${d.id}')">
      <td>${formatDate(d.date)}</td>
      <td><strong>${esc(d.entreprise)}</strong>${d.lieu ? `<br><span style="color:var(--text2);font-size:0.75rem">ğŸ“ ${esc(d.lieu)}</span>` : ''}</td>
      <td>${esc(d.poste)}${d.url ? ` <a href="${esc(d.url)}" target="_blank" style="color:var(--accent)">ğŸ”—</a>` : ''}</td>
      <td>${esc(d.contact) || '<span style="color:var(--text2)">â€”</span>'}</td>
      <td>${esc(d.source)}</td>
      <td><span class="badge ${badgeClass}">${statutLabels[d.statut] || d.statut}</span></td>
      <td>${relanceHtml}</td>
      <td title="${esc(d.notes)}">${esc(truncate(d.notes, 40))}</td>
      <td class="actions-cell">
        <button class="btn btn-icon btn-small btn-secondary" onclick="openModal('${d.id}')" title="Modifier">âœï¸</button>
        <button class="btn btn-icon btn-small btn-secondary" onclick="quickRelance('${d.id}')" title="Marquer relancÃ©">ğŸ”„</button>
      </td>
    </tr>`;
  }).join('');
}

function formatDate(d) { if (!d) return 'â€”'; const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
function truncate(s, n) { if (!s) return ''; return s.length > n ? s.substring(0,n) + '...' : s; }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// SORT
function sortBy(field) {
  if (currentSort.field === field) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  else { currentSort.field = field; currentSort.dir = 'desc'; }
  renderTable();
}

// FILTER
function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

// MODAL
function openModal(id) {
  const modal = document.getElementById('modal');
  const isEdit = !!id;
  document.getElementById('modalTitle').textContent = isEdit ? 'Modifier la candidature' : 'Nouvelle candidature';
  document.getElementById('deleteBtn').style.display = isEdit ? 'inline-flex' : 'none';

  if (isEdit) {
    const entry = data.find(d => d.id === id);
    if (!entry) return;
    document.getElementById('editId').value = id;
    document.getElementById('fEntreprise').value = entry.entreprise || '';
    document.getElementById('fPoste').value = entry.poste || '';
    document.getElementById('fContact').value = entry.contact || '';
    document.getElementById('fSource').value = entry.source || 'Indeed';
    document.getElementById('fDate').value = entry.date || '';
    document.getElementById('fStatut').value = entry.statut || 'envoyee';
    document.getElementById('fRelanceDate').value = entry.relanceDate || '';
    document.getElementById('fLieu').value = entry.lieu || '';
    document.getElementById('fUrl').value = entry.url || '';
    document.getElementById('fSalaire').value = entry.salaire || '';
    document.getElementById('fNotes').value = entry.notes || '';
    // Timeline
    renderTimeline(entry);
  } else {
    document.getElementById('editId').value = '';
    document.getElementById('fEntreprise').value = '';
    document.getElementById('fPoste').value = '';
    document.getElementById('fContact').value = '';
    document.getElementById('fSource').value = 'Indeed';
    document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('fStatut').value = 'envoyee';
    document.getElementById('fRelanceDate').value = getDefaultRelance();
    document.getElementById('fLieu').value = '';
    document.getElementById('fUrl').value = '';
    document.getElementById('fSalaire').value = '';
    document.getElementById('fNotes').value = '';
    document.getElementById('timelineContainer').innerHTML = '';
  }

  modal.classList.add('active');
  document.getElementById('fEntreprise').focus();
}

function closeModal() { document.getElementById('modal').classList.remove('active'); }

function getDefaultRelance() {
  const d = new Date();
  d.setDate(d.getDate() + 7);
  return d.toISOString().split('T')[0];
}

function renderTimeline(entry) {
  if (!entry.history || entry.history.length === 0) {
    document.getElementById('timelineContainer').innerHTML = '';
    return;
  }
  const html = `<div style="margin-top:20px"><label style="font-size:0.75rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;">Historique</label><div class="timeline">${
    entry.history.map(h => `<div class="timeline-item"><span class="timeline-date">${formatDate(h.date)}</span><span class="timeline-text">${esc(h.action)}</span></div>`).join('')
  }</div></div>`;
  document.getElementById('timelineContainer').innerHTML = html;
}

// SAVE
function saveEntry() {
  const entreprise = document.getElementById('fEntreprise').value.trim();
  const poste = document.getElementById('fPoste').value.trim();
  if (!entreprise || !poste) { toast('âš ï¸ Entreprise et poste sont requis', 'var(--orange)'); return; }

  const id = document.getElementById('editId').value;
  const newStatut = document.getElementById('fStatut').value;
  
  const entry = {
    id: id || crypto.randomUUID(),
    entreprise,
    poste,
    contact: document.getElementById('fContact').value.trim(),
    source: document.getElementById('fSource').value,
    date: document.getElementById('fDate').value,
    statut: newStatut,
    relanceDate: document.getElementById('fRelanceDate').value,
    lieu: document.getElementById('fLieu').value.trim(),
    url: document.getElementById('fUrl').value.trim(),
    salaire: document.getElementById('fSalaire').value.trim(),
    notes: document.getElementById('fNotes').value.trim(),
    history: [],
    updatedAt: new Date().toISOString()
  };

  if (id) {
    const idx = data.findIndex(d => d.id === id);
    if (idx !== -1) {
      const old = data[idx];
      entry.history = old.history || [];
      entry.createdAt = old.createdAt;
      if (old.statut !== newStatut) {
        entry.history.push({ date: new Date().toISOString().split('T')[0], action: `Statut: ${old.statut} â†’ ${newStatut}` });
      }
      data[idx] = entry;
    }
  } else {
    entry.createdAt = new Date().toISOString();
    entry.history = [{ date: entry.date, action: 'Candidature crÃ©Ã©e' }];
    data.push(entry);
  }

  save();
  closeModal();
  toast(id ? 'âœï¸ Candidature mise Ã  jour' : 'âœ… Candidature ajoutÃ©e');
}

// DELETE
function deleteEntry() {
  const id = document.getElementById('editId').value;
  if (!id || !confirm('Supprimer cette candidature ?')) return;
  data = data.filter(d => d.id !== id);
  save();
  closeModal();
  toast('ğŸ—‘ï¸ Candidature supprimÃ©e', 'var(--red)');
}

// QUICK RELANCE
function quickRelance(id) {
  const entry = data.find(d => d.id === id);
  if (!entry) return;
  entry.statut = 'relancee';
  const today = new Date().toISOString().split('T')[0];
  entry.history = entry.history || [];
  entry.history.push({ date: today, action: 'Relance effectuÃ©e' });
  const next = new Date(); next.setDate(next.getDate() + 7);
  entry.relanceDate = next.toISOString().split('T')[0];
  entry.updatedAt = new Date().toISOString();
  save();
  toast('ğŸ”„ Relance enregistrÃ©e');
}

// EXPORT / IMPORT
function exportData() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `job-tracker-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('ğŸ“¤ DonnÃ©es exportÃ©es');
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = JSON.parse(ev.target.result);
        if (!Array.isArray(imported)) throw new Error('Format invalide');
        if (confirm(`Importer ${imported.length} candidatures ? (les donnÃ©es actuelles seront remplacÃ©es)`)) {
          data = imported;
          save();
          toast(`ğŸ“¥ ${imported.length} candidatures importÃ©es`);
        }
      } catch(err) { toast('âŒ Fichier invalide', 'var(--red)'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

// TOAST
function toast(msg, color) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = color || 'var(--green)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// KEYBOARD
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeModal(); closeEsnModal(); }
  if (e.key === 'n' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
    e.preventDefault();
    const esnActive = document.getElementById('section-esn').classList.contains('active');
    esnActive ? openEsnModal() : openModal();
  }
});

// ========== TAB SWITCHING ==========
function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`section-${tab}`).classList.add('active');
  if (tab === 'esn') renderEsnGrid();
}

// ========== ESN DATA ==========
let esnData = JSON.parse(localStorage.getItem('esn-directory') || '[]');
let esnFilter = 'all';

async function saveEsnData() {
  localStorage.setItem('esn-directory', JSON.stringify(esnData));
  if (fileHandle) {
    // Save ESN alongside candidatures in a combined export? No â€” separate file
    // ESN uses its own localStorage key, we'll also try esn-data.json
  }
  updateTabCounts();
  renderEsnStats();
  renderEsnGrid();
}

// ========== HUNTER.IO ==========
const HUNTER_API_KEY = '8e779883f7c8b58e8dc8611021c530a81e641532';

async function hunterSearch(esnId) {
  const entry = esnData.find(e => e.id === esnId);
  if (!entry) return;

  // Extract domain from site URL
  let domain = '';
  if (entry.site) {
    try { domain = new URL(entry.site).hostname.replace('www.', ''); } catch(e) {}
  }
  if (!domain) {
    // Prompt user for domain
    domain = prompt(`Pas de site web renseignÃ© pour ${entry.nom}.\nEntre le domaine (ex: helpline.fr) :`);
    if (!domain) return;
    domain = domain.replace(/^https?:\/\//, '').replace('www.', '').replace(/\/.*/, '');
  }

  toast(`ğŸ” Recherche Hunter.io sur ${domain}...`);

  try {
    const resp = await fetch(`https://api.hunter.io/v2/domain-search?domain=${encodeURIComponent(domain)}&api_key=${HUNTER_API_KEY}&limit=20`);
    const json = await resp.json();

    if (json.errors) {
      toast(`âŒ Hunter: ${json.errors[0].details || json.errors[0].message}`, 'var(--red)');
      return;
    }

    const emails = json.data?.emails || [];
    if (emails.length === 0) {
      toast(`âš ï¸ Aucun contact trouvÃ© pour ${domain}`, 'var(--orange)');
      return;
    }

    // Filter for relevant roles (RH, recrutement, talent, HR)
    const rhKeywords = ['recru', 'talent', 'rh', 'hr', 'human', 'people', 'staffing', 'hiring'];
    const allContacts = emails.map(e => ({
      nom: [e.first_name, e.last_name].filter(Boolean).join(' ') || '',
      role: e.position || '',
      email: e.value || '',
      telephone: e.phone_number || '',
      linkedin: e.linkedin || '',
      confidence: e.confidence || 0,
      isRH: rhKeywords.some(k => (e.position || '').toLowerCase().includes(k) || (e.department || '').toLowerCase().includes(k))
    }));

    // Sort: RH first, then by confidence
    allContacts.sort((a, b) => {
      if (a.isRH && !b.isRH) return -1;
      if (!a.isRH && b.isRH) return 1;
      return b.confidence - a.confidence;
    });

    // Merge with existing contacts (don't duplicate emails)
    entry.contacts = entry.contacts || [];
    const existingEmails = new Set(entry.contacts.map(c => c.email.toLowerCase()));
    let added = 0;

    for (const c of allContacts) {
      if (c.email && !existingEmails.has(c.email.toLowerCase())) {
        entry.contacts.push({
          nom: c.nom,
          role: c.role + (c.isRH ? ' â­' : ''),
          email: c.email,
          telephone: c.telephone,
          linkedin: c.linkedin
        });
        existingEmails.add(c.email.toLowerCase());
        added++;
      }
    }

    // Update site domain if not set
    if (!entry.site) entry.site = `https://${domain}`;
    
    // Store pattern info
    const pattern = json.data?.pattern;
    if (pattern) {
      entry.emailPattern = pattern;
      entry.notes = (entry.notes || '') + `\nğŸ“§ Pattern email: ${pattern}@${domain}`;
    }

    entry.updatedAt = new Date().toISOString();
    saveEsnData();

    toast(`âœ… Hunter: ${added} contact(s) ajoutÃ©(s) pour ${entry.nom} (${emails.length} trouvÃ©s)`);

    // If modal is open on this entry, refresh it
    if (document.getElementById('esnEditId').value === esnId) {
      openEsnModal(esnId);
    }

  } catch(e) {
    toast(`âŒ Erreur Hunter: ${e.message}`, 'var(--red)');
  }
}

// Hunter quota check
async function hunterQuota() {
  try {
    const resp = await fetch(`https://api.hunter.io/v2/account?api_key=${HUNTER_API_KEY}`);
    const json = await resp.json();
    const d = json.data;
    if (d) {
      const used = d.requests?.searches?.used || 0;
      const avail = d.requests?.searches?.available || 0;
      toast(`ğŸ“Š Hunter.io: ${used}/${avail} recherches utilisÃ©es ce mois`, 'var(--accent)');
    }
  } catch(e) {}
}

const ESN_SEED_DATA = [
  {"id":"esn-helpline","nom":"HELPLINE","type":"esn","priorite":"new","site":"https://www.helpline.fr","carrieres":"https://www.helpline.fr/nous-rejoindre","ville":"Marcq-en-BarÅ“ul (59)","specialites":"Support applicatif, InfogÃ©rance, ProximitÃ©","linkedin":"https://www.linkedin.com/company/helpline/","contacts":[],"contactRefIds":["contact-isabelle-neri-helpline"],"notes":"ESN spÃ©cialisÃ©e support/infogÃ©rance. Candidature envoyÃ©e pour poste Support Retail.","candidatureIds":["hw-helpline-retail"]},
  {"id":"esn-osmozium","nom":"OSMOZIUM","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Support N1, InfogÃ©rance retail","linkedin":"","contacts":[],"notes":"ESN. Support N1 rÃ©seau magasins + siÃ¨ge. 7j/7 roulement.","candidatureIds":["hw-osmozium"]},
  {"id":"esn-securinfor","nom":"Securinfor","type":"esn","priorite":"new","site":"https://www.securinfor.com","carrieres":"","ville":"Wasquehal (59)","specialites":"Support proximitÃ©, InfogÃ©rance","linkedin":"","contacts":[],"contactRefIds":["contact-romain-huot-securinfor","contact-olivier-trenquier-securinfor","contact-damien-paquin-securinfor","contact-olivier-verdier-securinfor"],"notes":"ESN. Support proximitÃ© N1/N2, gestion parc, ticketing.","candidatureIds":["hw-securinfor"]},
  {"id":"esn-astek","nom":"Astek / Tekneum","type":"esn","priorite":"new","site":"https://www.astek.fr","carrieres":"https://www.astek.fr/offres","ville":"Lille (59)","specialites":"Support N1/N2, ProximitÃ©, VIP, Infrastructure","linkedin":"https://www.linkedin.com/company/astek/","contacts":[],"notes":"Grand groupe ESN. Deux candidatures.","candidatureIds":["hw-astek","linkedin-tekneum-astek"]},
  {"id":"esn-econocom","nom":"Econocom","type":"esn","priorite":"new","site":"https://www.econocom.com","carrieres":"https://www.econocom.com/fr/carrieres","ville":"Lille (59)","specialites":"Support utilisateurs, Digital workplace","linkedin":"https://www.linkedin.com/company/econocom/","contacts":[],"contactRefIds":["contact-fatia-makhloufi-econocom"],"notes":"Grand groupe.","candidatureIds":["hw-econocom"]},
  {"id":"esn-draks","nom":"Draks","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Support utilisateurs","linkedin":"","contacts":[],"notes":"ESN.","candidatureIds":["hw-draks"]},
  {"id":"esn-actual-talent","nom":"Actual Talent (ex Up Skills)","type":"interim","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Helpdesk, Support proximitÃ©","linkedin":"","contacts":[],"notes":"IntÃ©rim/recrutement IT.","candidatureIds":["hw-actual-talent","hw-actual-talent-proxi"]},
  {"id":"esn-reproit","nom":"REPRO-IT (Groupe IT & You)","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Helpdesk, VoIP, Support N1/N2","linkedin":"","contacts":[],"notes":"ESN groupe IT & You.","candidatureIds":["hw-reproit"]},
  {"id":"cab-michael-page","nom":"Michael Page","type":"cabinet","priorite":"new","site":"https://www.michaelpage.fr","carrieres":"https://www.michaelpage.fr/emploi/informatique","ville":"Lille (59)","specialites":"Recrutement IT, Support, Infra, Dev","linkedin":"https://www.linkedin.com/company/michael-page/","contacts":[],"notes":"Division Technology. Chercher consultants IT/Support LinkedIn Lille.","candidatureIds":[]},
  {"id":"cab-hays","nom":"Hays","type":"cabinet","priorite":"new","site":"https://www.hays.fr","carrieres":"https://www.hays.fr/emploi/informatique-telecoms","ville":"Lille (59)","specialites":"Recrutement IT, Support, Infra, SystÃ¨mes & RÃ©seaux","linkedin":"https://www.linkedin.com/company/hays/","contacts":[],"notes":"Gros cabinet international. Division IT Lille. Beaucoup d'offres Support/Helpdesk Nord.","candidatureIds":[]},
  {"id":"cab-robert-half","nom":"Robert Half","type":"cabinet","priorite":"new","site":"https://www.roberthalf.fr","carrieres":"https://www.roberthalf.fr/offres-emploi/informatique","ville":"Lille (59)","specialites":"Recrutement IT, Support, Admin Sys, Infrastructure","linkedin":"https://www.linkedin.com/company/robert-half-international/","contacts":[],"notes":"Cabinet US. Division Technology. Bureau Lille.","candidatureIds":[]},
  {"id":"cab-spring","nom":"Spring (Groupe Adecco)","type":"cabinet","priorite":"new","site":"https://www.spring-france.com","carrieres":"https://www.spring-france.com/offres-emploi","ville":"Lille (59)","specialites":"Recrutement cadres & techniciens IT","linkedin":"https://www.linkedin.com/company/spring-france/","contacts":[],"notes":"Branche recrutement Adecco. Positions techniques et cadres IT.","candidatureIds":[]},
  {"id":"cab-free-work","nom":"Free-Work (ex Freelance-info)","type":"cabinet","priorite":"new","site":"https://www.free-work.com","carrieres":"https://www.free-work.com/fr/tech-it/jobs","ville":"Nationale","specialites":"Plateforme emploi IT, CDI/Freelance","linkedin":"https://www.linkedin.com/company/free-work/","contacts":[],"notes":"Plateforme spÃ©cialisÃ©e IT. Inscription profil recommandÃ©e.","candidatureIds":[]},
  {"id":"cab-jefferson-frank","nom":"Jefferson Frank","type":"cabinet","priorite":"new","site":"https://www.jeffersonfrank.com/fr","carrieres":"https://www.jeffersonfrank.com/fr/emplois","ville":"Lille / Nationale","specialites":"Recrutement IT spÃ©cialisÃ©, Cloud, Support","linkedin":"https://www.linkedin.com/company/jefferson-frank/","contacts":[],"notes":"Cabinet spÃ©cialisÃ© IT/Cloud. Consultants dÃ©diÃ©s par techno.","candidatureIds":[]},
  {"id":"cab-lhh","nom":"LHH (Lee Hecht Harrison)","type":"cabinet","priorite":"new","site":"https://www.lhh.com/fr","carrieres":"","ville":"Lille (59)","specialites":"Recrutement, transition carriÃ¨re, IT","linkedin":"https://www.linkedin.com/company/lhh/","contacts":[],"notes":"Groupe Adecco. Recrutement + accompagnement reconversion. Pertinent profil reconversion IT.","candidatureIds":[]},
  {"id":"int-expectra","nom":"Expectra","type":"interim","priorite":"new","site":"https://www.expectra.fr","carrieres":"https://www.expectra.fr/offres-emploi/informatique","ville":"Lille (59)","specialites":"IntÃ©rim IT qualifiÃ©, Support, Admin Sys","linkedin":"https://www.linkedin.com/company/expectra/","contacts":[],"notes":"IntÃ©rim spÃ©cialisÃ© cadres & techniciens. Groupe Randstad. Bon tremplin CDI.","candidatureIds":[]},
  {"id":"int-randstad-digital","nom":"Randstad Digital (ex Ausy)","type":"interim","priorite":"new","site":"https://www.randstaddigital.fr","carrieres":"https://www.randstaddigital.fr/offres","ville":"Lille (59)","specialites":"Consulting IT, Support, Infrastructure, Cloud","linkedin":"https://www.linkedin.com/company/randstad-digital/","contacts":[],"notes":"ESN/IntÃ©rim groupe Randstad. Gros volume missions IT Nord.","candidatureIds":[]},
  {"id":"int-modis","nom":"Akkodis (ex Modis)","type":"interim","priorite":"new","site":"https://www.akkodis.com/fr","carrieres":"https://www.akkodis.com/fr/offres-emploi","ville":"Lille (59)","specialites":"Consulting IT, Support, Infra, Digital","linkedin":"https://www.linkedin.com/company/akkodis/","contacts":[],"notes":"Groupe Adecco. Missions longues possibles â†’ CDI.","candidatureIds":[]},
  {"id":"int-proxiel","nom":"Proxiel","type":"interim","priorite":"new","site":"https://www.proxiel.fr","carrieres":"","ville":"Lille (59)","specialites":"IntÃ©rim IT, Support, Helpdesk, ProximitÃ©","linkedin":"https://www.linkedin.com/company/proxiel/","contacts":[],"notes":"IntÃ©rim IT Nord. Plus petite mais bien implantÃ©e localement.","candidatureIds":[]},
  {"id":"int-sii","nom":"SII","type":"esn","priorite":"new","site":"https://www.groupe-sii.com","carrieres":"https://www.groupe-sii.com/fr/rejoindre-sii","ville":"Lille (59)","specialites":"Consulting IT, Support, Infra, Dev","linkedin":"https://www.linkedin.com/company/sii/","contacts":[],"notes":"Grande ESN franÃ§aise. Agence Lille.","candidatureIds":[]},
  {"id":"int-alten","nom":"Alten","type":"esn","priorite":"new","site":"https://www.alten.fr","carrieres":"https://www.alten.fr/rejoignez-nous","ville":"Lille (59)","specialites":"Consulting IT, IngÃ©nierie, Support, Infra","linkedin":"https://www.linkedin.com/company/alten/","contacts":[],"notes":"Grande ESN. Bureau Lille. OrientÃ© ingÃ©nierie mais missions support possibles.","candidatureIds":[]},
  {"id":"int-capgemini","nom":"Capgemini","type":"esn","priorite":"new","site":"https://www.capgemini.com/fr-fr","carrieres":"https://www.capgemini.com/fr-fr/carrieres","ville":"Lille (59)","specialites":"InfogÃ©rance, Support, Infrastructure, Cloud","linkedin":"https://www.linkedin.com/company/capgemini/","contacts":[],"notes":"GÃ©ant ESN. InfogÃ©rance = postes support N1/N2. Bureau Lille dÃ©veloppÃ©.","candidatureIds":[]},
  {"id":"esn-sopra-steria","nom":"Sopra Steria","type":"esn","priorite":"new","site":"https://www.soprasteria.com/fr","carrieres":"https://www.soprasteria.com/fr/nous-rejoindre","ville":"Lille (59)","specialites":"InfogÃ©rance, Support, Infrastructure, Transformation digitale","linkedin":"https://www.linkedin.com/company/soprasteria/","contacts":[],"notes":"Grande ESN. Fort sur infogÃ©rance = postes support. SiÃ¨ge historique Nord.","candidatureIds":[]},
  {"id":"cab-externatic","nom":"Externatic","type":"cabinet","priorite":"new","site":"https://www.externatic.fr","carrieres":"https://www.externatic.fr/offres-emploi","ville":"Lille (59)","specialites":"Recrutement IT pur, Dev, Infra, Support, Data","linkedin":"https://www.linkedin.com/company/externatic/","contacts":[],"notes":"â­ Cabinet 100% IT. TrÃ¨s bonne rÃ©putation. Approche humaine. Ã€ contacter en prioritÃ©.","candidatureIds":[]},
  {"id":"cab-winsearch","nom":"Winsearch Lille","type":"cabinet","priorite":"new","site":"https://www.winsearch.fr","carrieres":"https://www.winsearch.fr/offres-emploi","ville":"Lille (59)","specialites":"Recrutement experts & cadres, IT, Finance","linkedin":"https://www.linkedin.com/company/winsearch/","contacts":[],"notes":"Cabinet chasse / recrutement qualifiÃ©. Postes N2+.","candidatureIds":[]},
  {"id":"cab-youman-pro","nom":"YOUMAN-PRO","type":"cabinet","priorite":"new","site":"https://www.youman-pro.fr","carrieres":"","ville":"Lille (59)","specialites":"Recrutement local, coaching CV/entretien","linkedin":"","contacts":[],"notes":"Cabinet local. Coaching CV et prÃ©pa entretien + recrutement.","candidatureIds":[]},
  {"id":"cab-studio-rh","nom":"Studio RH","type":"cabinet","priorite":"new","site":"https://www.studiorh.fr","carrieres":"","ville":"Lille (59)","specialites":"Recrutement informatique & digital","linkedin":"https://www.linkedin.com/company/studiorh/","contacts":[],"notes":"SpÃ©cialisÃ© IT/digital Lille. Local, plus accessible.","candidatureIds":[]},
  {"id":"cab-adsearch","nom":"Adsearch Lille","type":"cabinet","priorite":"new","site":"https://www.adsearch.fr","carrieres":"https://www.adsearch.fr/offres-emploi","ville":"Lille (59)","specialites":"Recrutement middle/senior, IT, Digital, Finance","linkedin":"https://www.linkedin.com/company/adsearch/","contacts":[],"notes":"Bien notÃ©. Consultants spÃ©cialisÃ©s par secteur.","candidatureIds":[]},
  {"id":"cab-keylinkjob","nom":"Keylinkjob","type":"cabinet","priorite":"new","site":"https://www.keylinkjob.fr","carrieres":"","ville":"Lille (59)","specialites":"Recrutement multi-secteurs, IT possible","linkedin":"","contacts":[],"notes":"GÃ©nÃ©raliste avec bons retours.","candidatureIds":[]},
  {"id":"cab-econsulting","nom":"e-Consulting RH","type":"cabinet","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Recrutement startup, digital, numÃ©rique","linkedin":"","contacts":[],"notes":"OrientÃ© startup/digital.","candidatureIds":[]},
  {"id":"esn-bbnd","nom":"BBND","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"DÃ©veloppement, Services digitaux","linkedin":"","contacts":[],"notes":"ESN digitale Lille. Forte rÃ©activitÃ©.","candidatureIds":[]},
  {"id":"esn-unis","nom":"UNIS","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Villeneuve-d'Ascq (59)","specialites":"Conseil, IntÃ©gration, Prestation IT","linkedin":"","contacts":[],"notes":"ESN bien implantÃ©e Villeneuve-d'Ascq.","candidatureIds":[]},
  {"id":"esn-quadra","nom":"Quadra Informatique","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Services numÃ©riques PME, Projets entreprise","linkedin":"","contacts":[],"notes":"ESN & services numÃ©riques orientÃ©e PME.","candidatureIds":[]},
  {"id":"esn-inside","nom":"Inside Lille","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Transformation digitale, DevOps, IT","linkedin":"","contacts":[],"notes":"Services IT, projets transfo digitale & DevOps.","candidatureIds":[]},
  {"id":"esn-esenca","nom":"ESENCA - Solutions IT","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lezennes (59)","specialites":"Solutions informatiques","linkedin":"","contacts":[],"notes":"ESN basÃ©e Lezennes.","candidatureIds":[]},
  {"id":"esn-younup","nom":"Younup Lille","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Conseil IT, DÃ©veloppement, Missions","linkedin":"","contacts":[],"notes":"SociÃ©tÃ© conseil & IT.","candidatureIds":[]},
  {"id":"esn-selfing","nom":"SELFING","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Consulting IT, Prestations informatiques","linkedin":"","contacts":[],"notes":"Consultant informatique & prestations IT Lille.","candidatureIds":[]},
  {"id":"esn-apside","nom":"Apside Nord","type":"esn","priorite":"new","site":"https://www.apside.com","carrieres":"https://www.apside.com/rejoignez-nous","ville":"Lille (59)","specialites":"ESN nationale, Missions diversifiÃ©es, Support, Infra, Dev","linkedin":"https://www.linkedin.com/company/apside/","contacts":[],"notes":"Filiale Nord d'une ESN nationale. Missions variÃ©es.","candidatureIds":[]},
  {"id":"esn-smile","nom":"Smile Open Source","type":"esn","priorite":"new","site":"https://www.smile.eu","carrieres":"https://www.smile.eu/fr/carrieres","ville":"Lille (59)","specialites":"Open source, IntÃ©gration, Solutions digitales","linkedin":"https://www.linkedin.com/company/smile/","contacts":[],"notes":"ESN open-source. IntÃ©gration solutions. Bureau Lille.","candidatureIds":[]},
  {"id":"esn-goweb","nom":"Goweb","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Roubaix (59)","specialites":"ESN indÃ©pendante, Services IT","linkedin":"","contacts":[],"notes":"ESN indÃ©pendante Roubaix.","candidatureIds":[]},
  {"id":"esn-icsis","nom":"Icsis","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Lille (59)","specialites":"Projets IT divers","linkedin":"","contacts":[],"notes":"ESN lilloise, projets IT variÃ©s.","candidatureIds":[]},
  {"id":"esn-numen","nom":"Numen Services","type":"esn","priorite":"new","site":"","carrieres":"","ville":"Marcq-en-BarÅ“ul (59)","specialites":"Services IT","linkedin":"","contacts":[],"notes":"SociÃ©tÃ© services IT Marcq-en-BarÅ“ul.","candidatureIds":[]},
  {"id":"esn-experis","nom":"Experis (ManpowerGroup)","type":"esn","priorite":"new","site":"https://www.experis.fr","carrieres":"https://www.experis.fr/candidats/offres-emploi","ville":"Lille (59)","specialites":"Consulting IT, Support, Infrastructure, CybersÃ©curitÃ©, Cloud","linkedin":"https://www.linkedin.com/company/experis/","contacts":[],"notes":"Branche IT de ManpowerGroup. Gros volume de missions IT Nord. Support, infra, cybersec. Bon tremplin â€” entre ESN et intÃ©rim qualifiÃ©.","candidatureIds":[]}
];

async function initEsnData() {
  // Load localStorage first (has user edits)
  const localData = JSON.parse(localStorage.getItem('esn-directory') || '[]');

  // Also try loading esn-data.json for contactRefIds and new entries
  let fileData = [];
  try {
    const resp = await fetch('esn-data.json');
    if (resp.ok) fileData = await resp.json();
  } catch(e) { console.warn('esn-data.json non chargÃ©:', e); }

  // Build a seed map from both ESN_SEED_DATA and esn-data.json (file wins)
  const seedMap = new Map();
  for (const entry of ESN_SEED_DATA) seedMap.set(entry.id, entry);
  for (const entry of fileData) seedMap.set(entry.id, entry);
  const mergedSeed = [...seedMap.values()];

  if (localData.length > 0) {
    // Merge: localStorage wins for existing, seed adds new entries
    const localIds = new Set(localData.map(e => e.id));
    const localNames = new Set(localData.map(e => e.nom.toLowerCase()));
    esnData = [...localData];

    // Sync contactRefIds from seed/file into localStorage entries
    const seedById = new Map(mergedSeed.map(e => [e.id, e]));
    for (const entry of esnData) {
      const seed = seedById.get(entry.id);
      if (seed && seed.contactRefIds && seed.contactRefIds.length > 0) {
        // Merge: add seed refs not already present
        const existing = new Set(entry.contactRefIds || []);
        const merged = [...(entry.contactRefIds || [])];
        for (const refId of seed.contactRefIds) {
          if (!existing.has(refId)) merged.push(refId);
        }
        entry.contactRefIds = merged;
      }
    }

    let added = 0;
    for (const entry of mergedSeed) {
      if (!localIds.has(entry.id) && !localNames.has(entry.nom.toLowerCase())) {
        esnData.push(entry);
        added++;
      }
    }
    if (added > 0) toast(`ğŸ“¥ ${added} nouvelles fiches ajoutÃ©es au RÃ©seau Pro`);
  } else {
    esnData = [...mergedSeed];
  }

  // Auto-detect ESN from candidatures
  autoDetectEsn();
  localStorage.setItem('esn-directory', JSON.stringify(esnData));
  updateTabCounts();
  renderEsnStats();
  renderEsnGrid();
}

function autoDetectEsn() {
  // Scan candidatures for ESN keywords and auto-add new ones
  const esnKeywords = ['ESN', 'SSII', 'infogÃ©rance', 'prestataire'];
  const existingNames = new Set(esnData.map(e => e.nom.toLowerCase()));
  
  const esnCandidatures = data.filter(d => {
    const notes = (d.notes || '').toLowerCase();
    return notes.includes('esn') || notes.includes('ssii') || notes.includes('infogÃ©rance');
  });

  let added = 0;
  for (const c of esnCandidatures) {
    const name = c.entreprise;
    if (!existingNames.has(name.toLowerCase())) {
      esnData.push({
        id: 'esn-' + crypto.randomUUID().slice(0, 8),
        nom: name,
        priorite: 'new',
        site: '',
        carrieres: '',
        ville: c.lieu || '',
        specialites: '',
        linkedin: '',
        contacts: [],
        notes: `Auto-dÃ©tectÃ©e depuis candidature: ${c.poste}`,
        candidatureIds: [c.id],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      existingNames.add(name.toLowerCase());
      added++;
    } else {
      // Link candidature to existing ESN
      const esn = esnData.find(e => e.nom.toLowerCase() === name.toLowerCase());
      if (esn && (!esn.candidatureIds || !esn.candidatureIds.includes(c.id))) {
        esn.candidatureIds = esn.candidatureIds || [];
        esn.candidatureIds.push(c.id);
      }
    }
  }
  if (added > 0) {
    localStorage.setItem('esn-directory', JSON.stringify(esnData));
  }
}

function updateTabCounts() {
  document.getElementById('tabCountCandidatures').textContent = data.length;
  document.getElementById('tabCountEsn').textContent = esnData.length;
}

function renderEsnStats() {
  const total = esnData.length;
  const countEsn = esnData.filter(e => (e.type || 'esn') === 'esn').length;
  const countCabinet = esnData.filter(e => e.type === 'cabinet').length;
  const countInterim = esnData.filter(e => e.type === 'interim').length;
  const hot = esnData.filter(e => e.priorite === 'hot').length;
  const withContact = esnData.filter(e =>
    (e.contacts && e.contacts.length > 0) || (e.contactRefIds && e.contactRefIds.length > 0)
  ).length;
  const withEmail = esnData.filter(e => {
    const hasInline = e.contacts && e.contacts.some(c => c.email);
    const hasLinked = (e.contactRefIds || []).some(id => { const rc = contactsData.find(c => c.id === id); return rc && rc.email; });
    return hasInline || hasLinked;
  }).length;
  const withPhone = esnData.filter(e => {
    const hasInline = e.contacts && e.contacts.some(c => c.telephone);
    const hasLinked = (e.contactRefIds || []).some(id => { const rc = contactsData.find(c => c.id === id); return rc && rc.telephone; });
    return hasInline || hasLinked;
  }).length;

  document.getElementById('esn-stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-number">${total}</div><div class="stat-label">Total</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--accent2)">${countEsn}</div><div class="stat-label">ğŸ¢ ESN</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--pink)">${countCabinet}</div><div class="stat-label">ğŸ¯ Cabinets</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--yellow)">${countInterim}</div><div class="stat-label">â³ IntÃ©rim</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--red)">${hot}</div><div class="stat-label">ğŸ”´ Hot</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--green)">${withContact}</div><div class="stat-label">Avec contact</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--blue)">${withEmail}</div><div class="stat-label">ğŸ“§ Email</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--purple)">${withPhone}</div><div class="stat-label">ğŸ“ TÃ©lÃ©phone</div></div>
  `;
}

function setEsnFilter(filter, btn) {
  esnFilter = filter;
  document.querySelectorAll('[data-esn-filter]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderEsnGrid();
}

function renderEsnGrid() {
  const query = document.getElementById('esnSearchInput').value.toLowerCase();
  let filtered = esnData.filter(e => {
    if (esnFilter.startsWith('type-') && (e.type || 'esn') !== esnFilter.replace('type-', '')) return false;
    if (!esnFilter.startsWith('type-') && esnFilter !== 'all' && e.priorite !== esnFilter) return false;
    if (query) {
      const linkedText = (e.contactRefIds || []).map(id => { const rc = contactsData.find(c => c.id === id); return rc ? `${rc.nom} ${rc.role} ${rc.email} ${rc.telephone} ${rc.entreprise}` : ''; }).join(' ');
      const hay = `${e.nom} ${e.ville} ${e.specialites} ${e.notes} ${(e.contacts||[]).map(c => `${c.nom} ${c.role} ${c.email} ${c.telephone}`).join(' ')} ${linkedText}`.toLowerCase();
      if (!hay.includes(query)) return false;
    }
    return true;
  });

  // Sort: hot first, then warm, new, cold
  const pOrder = { hot: 0, warm: 1, new: 2, cold: 3 };
  filtered.sort((a, b) => (pOrder[a.priorite] || 99) - (pOrder[b.priorite] || 99));

  const grid = document.getElementById('esnGrid');
  const empty = document.getElementById('esnEmptyState');

  if (filtered.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = filtered.map(e => {
    const priorityLabels = { hot: 'ğŸ”´ HOT', warm: 'ğŸŸ  WARM', cold: 'âšª COLD', new: 'ğŸ”µ NOUVEAU' };
    const typeLabels = { esn: 'ğŸ¢ ESN', cabinet: 'ğŸ¯ Cabinet', interim: 'â³ IntÃ©rim IT' };
    const eType = e.type || 'esn';
    
    // Count linked candidatures
    const linkedCount = e.candidatureIds ? e.candidatureIds.length : 0;

    // Render contacts (liÃ©s RH + inline)
    const linkedRefIds = e.contactRefIds || [];
    const inlineContacts = e.contacts || [];
    const statusIcons = {'a-contacter':'ğŸ“§','contacte':'âœ…','rdv':'ğŸ“…','suivi':'ğŸ”„','dead':'ğŸ’€'};

    const linkedHtml = linkedRefIds.map(refId => {
      const c = contactsData.find(rc => rc.id === refId);
      if (!c) return '';
      return `
        <div class="esn-contact-linked" onclick="event.stopPropagation(); openContactModal('${c.id}')">
          <span class="esn-contact-name">${esc(c.nom)}${c.role ? ` â€” <span class="esn-contact-role">${esc(c.role)}</span>` : ''}
            <span class="rh-badge">${statusIcons[c.statut] || ''} Fiche RH</span>
          </span>
          <div class="esn-contact-channels">
            ${c.email ? `<a href="mailto:${esc(c.email)}" title="Email" onclick="event.stopPropagation()">ğŸ“§ ${esc(c.email)}</a>` : ''}
            ${c.telephone ? `<a href="tel:${esc(c.telephone)}" title="TÃ©lÃ©phone" onclick="event.stopPropagation()">ğŸ“ ${esc(c.telephone)}</a>` : ''}
            ${c.linkedin ? `<a href="${esc(c.linkedin)}" target="_blank" title="LinkedIn" onclick="event.stopPropagation()">ğŸ’¼ LinkedIn</a>` : ''}
          </div>
        </div>`;
    }).filter(Boolean).join('');

    const inlineHtml = inlineContacts.map(c => `
        <div class="esn-contact">
          <span class="esn-contact-name">${esc(c.nom)}${c.role ? ` â€” <span class="esn-contact-role">${esc(c.role)}</span>` : ''}</span>
          <div class="esn-contact-channels">
            ${c.email ? `<a href="mailto:${esc(c.email)}" title="Email">ğŸ“§ ${esc(c.email)}</a>` : ''}
            ${c.telephone ? `<a href="tel:${esc(c.telephone)}" title="TÃ©lÃ©phone">ğŸ“ ${esc(c.telephone)}</a>` : ''}
            ${c.linkedin ? `<a href="${esc(c.linkedin)}" target="_blank" title="LinkedIn">ğŸ’¼ LinkedIn</a>` : ''}
          </div>
        </div>
    `).join('');

    let contactsHtml = '';
    if (linkedHtml || inlineHtml) {
      contactsHtml = `<div class="esn-contacts">${linkedHtml}${inlineHtml}</div>`;
    } else {
      contactsHtml = '<div style="color:var(--text2);font-size:0.8rem;margin:8px 0;">âš ï¸ Aucun contact identifiÃ©</div>';
    }

    return `
    <div class="esn-card" onclick="openEsnModal('${e.id}')">
      <div class="esn-card-header">
        <h3>${esc(e.nom)}</h3>
        <div style="display:flex;gap:6px;align-items:center;">
          <span style="font-size:0.68rem;color:var(--text2);background:var(--bg3);padding:2px 8px;border-radius:10px;">${typeLabels[eType] || eType}</span>
          <span class="esn-priority priority-${e.priorite}">${priorityLabels[e.priorite] || e.priorite}</span>
        </div>
      </div>
      ${contactsHtml}
      <div class="esn-meta">
        ${e.ville ? `<span class="esn-meta-item">ğŸ“ ${esc(e.ville)}</span>` : ''}
        ${e.specialites ? `<span class="esn-meta-item">ğŸ› ï¸ ${esc(e.specialites)}</span>` : ''}
        ${e.site ? `<a href="${esc(e.site)}" target="_blank" class="esn-meta-item" style="color:var(--accent2)" onclick="event.stopPropagation()">ğŸŒ Site</a>` : ''}
        ${e.linkedin ? `<a href="${esc(e.linkedin)}" target="_blank" class="esn-meta-item" style="color:var(--accent2)" onclick="event.stopPropagation()">ğŸ’¼ LinkedIn</a>` : ''}
      </div>
      ${linkedCount > 0 ? `<div class="esn-candidatures-count">ğŸ“‹ ${linkedCount} candidature${linkedCount > 1 ? 's' : ''} liÃ©e${linkedCount > 1 ? 's' : ''}</div>` : ''}
      ${e.notes ? `<div class="esn-notes">${esc(truncate(e.notes, 120))}</div>` : ''}
      <div style="margin-top:10px;display:flex;gap:6px;">
        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); hunterSearch('${e.id}')" title="Chercher contacts via Hunter.io">ğŸ” Hunter</button>
      </div>
    </div>`;
  }).join('');
}

// ESN MODAL
let contactFieldCount = 0;

function openEsnModal(id) {
  const modal = document.getElementById('esnModal');
  const isEdit = !!id;
  document.getElementById('esnModalTitle').textContent = isEdit ? 'Modifier ESN' : 'Nouvelle ESN';
  document.getElementById('esnDeleteBtn').style.display = isEdit ? 'inline-flex' : 'none';
  contactFieldCount = 0;

  if (isEdit) {
    const entry = esnData.find(e => e.id === id);
    if (!entry) return;
    document.getElementById('esnEditId').value = id;
    document.getElementById('esnNom').value = entry.nom || '';
    document.getElementById('esnType').value = entry.type || 'esn';
    document.getElementById('esnPriorite').value = entry.priorite || 'new';
    document.getElementById('esnSite').value = entry.site || '';
    document.getElementById('esnCarrieres').value = entry.carrieres || '';
    document.getElementById('esnVille').value = entry.ville || '';
    document.getElementById('esnSpecialites').value = entry.specialites || '';
    document.getElementById('esnLinkedin').value = entry.linkedin || '';
    document.getElementById('esnNotes').value = entry.notes || '';
    // Contacts inline
    document.getElementById('esnContactsList').innerHTML = '';
    if (entry.contacts && entry.contacts.length > 0) {
      entry.contacts.forEach(c => addContactField(c));
    }
    // Contacts RH liÃ©s
    esnModalLinkedIds = [...(entry.contactRefIds || [])];
    renderEsnLinkedContacts();
  } else {
    document.getElementById('esnEditId').value = '';
    document.getElementById('esnNom').value = '';
    document.getElementById('esnType').value = 'esn';
    document.getElementById('esnPriorite').value = 'new';
    document.getElementById('esnSite').value = '';
    document.getElementById('esnCarrieres').value = '';
    document.getElementById('esnVille').value = '';
    document.getElementById('esnSpecialites').value = '';
    document.getElementById('esnLinkedin').value = '';
    document.getElementById('esnNotes').value = '';
    document.getElementById('esnContactsList').innerHTML = '';
    // Reset contacts RH liÃ©s
    esnModalLinkedIds = [];
    document.getElementById('esnLinkedContactsList').innerHTML = '';
  }
  document.getElementById('esnLinkContactContainer').style.display = 'none';

  modal.classList.add('active');
  document.getElementById('esnNom').focus();
}

function closeEsnModal() { document.getElementById('esnModal').classList.remove('active'); }

function addContactField(prefill) {
  const idx = contactFieldCount++;
  const container = document.getElementById('esnContactsList');
  const div = document.createElement('div');
  div.className = 'esn-contact';
  div.style.marginBottom = '10px';
  div.innerHTML = `
    <div class="form-row" style="margin-bottom:6px">
      <div class="form-group" style="margin-bottom:0"><input type="text" id="cNom${idx}" placeholder="Nom du contact" value="${esc(prefill?.nom || '')}"></div>
      <div class="form-group" style="margin-bottom:0"><input type="text" id="cRole${idx}" placeholder="RÃ´le (RH, ChargÃ© recrutement...)" value="${esc(prefill?.role || '')}"></div>
    </div>
    <div class="form-row" style="margin-bottom:6px">
      <div class="form-group" style="margin-bottom:0"><input type="email" id="cEmail${idx}" placeholder="ğŸ“§ Email" value="${esc(prefill?.email || '')}"></div>
      <div class="form-group" style="margin-bottom:0"><input type="tel" id="cTel${idx}" placeholder="ğŸ“ TÃ©lÃ©phone" value="${esc(prefill?.telephone || '')}"></div>
    </div>
    <div class="form-group" style="margin-bottom:0"><input type="url" id="cLinkedin${idx}" placeholder="ğŸ’¼ LinkedIn du contact" value="${esc(prefill?.linkedin || '')}"></div>
    <button class="btn btn-small btn-danger" style="margin-top:6px" onclick="this.parentElement.remove()">âœ• Retirer</button>
  `;
  container.appendChild(div);
}

function collectContacts() {
  const contacts = [];
  for (let i = 0; i < contactFieldCount; i++) {
    const nom = document.getElementById(`cNom${i}`);
    if (!nom) continue; // removed
    const c = {
      nom: nom.value.trim(),
      role: document.getElementById(`cRole${i}`)?.value.trim() || '',
      email: document.getElementById(`cEmail${i}`)?.value.trim() || '',
      telephone: document.getElementById(`cTel${i}`)?.value.trim() || '',
      linkedin: document.getElementById(`cLinkedin${i}`)?.value.trim() || ''
    };
    if (c.nom || c.email || c.telephone) contacts.push(c);
  }
  return contacts;
}

// === LIAISON CONTACTS RH â†” ESN ===
let esnModalLinkedIds = [];

function resolveContactRef(contactId) {
  return contactsData.find(c => c.id === contactId) || null;
}

function showLinkContactRH() {
  const container = document.getElementById('esnLinkContactContainer');
  const isVisible = container.style.display !== 'none';
  container.style.display = isVisible ? 'none' : 'block';
  if (!isVisible) {
    const input = document.getElementById('esnLinkContactSearch');
    input.value = '';
    input.focus();
    filterContactRHAutocomplete('');
  }
}

function filterContactRHAutocomplete(query) {
  const dropdown = document.getElementById('esnLinkContactDropdown');
  const q = query.toLowerCase().trim();
  const alreadyLinked = new Set(esnModalLinkedIds);

  let results = contactsData.filter(c => {
    if (alreadyLinked.has(c.id)) return false;
    if (!q) return true;
    return c.nom.toLowerCase().includes(q) ||
           (c.entreprise || '').toLowerCase().includes(q) ||
           (c.role || '').toLowerCase().includes(q) ||
           (c.email || '').toLowerCase().includes(q);
  }).slice(0, 10);

  if (results.length === 0) {
    dropdown.innerHTML = '<div style="padding:10px;font-size:0.8rem;color:var(--text2);">Aucun contact RH disponible</div>';
  } else {
    dropdown.innerHTML = results.map(c => `
      <div class="rh-autocomplete-item" onclick="linkContactRH('${c.id}')">
        <div><strong>${esc(c.nom)}</strong>${c.role ? ` â€” ${esc(c.role)}` : ''}</div>
        <span class="rh-item-company">${esc(c.entreprise || '')}</span>
      </div>
    `).join('');
  }
  dropdown.classList.add('visible');
}

function linkContactRH(contactId) {
  if (!esnModalLinkedIds.includes(contactId)) {
    esnModalLinkedIds.push(contactId);
  }
  renderEsnLinkedContacts();
  document.getElementById('esnLinkContactContainer').style.display = 'none';
  toast('ğŸ”— Contact RH liÃ©');
}

function unlinkContactRH(contactId) {
  esnModalLinkedIds = esnModalLinkedIds.filter(id => id !== contactId);
  renderEsnLinkedContacts();
  toast('ğŸ”— Contact RH dÃ©liÃ©', 'var(--orange)');
}

function renderEsnLinkedContacts() {
  const container = document.getElementById('esnLinkedContactsList');
  if (esnModalLinkedIds.length === 0) { container.innerHTML = ''; return; }
  const statusLabels = {'a-contacter':'ğŸ“§','contacte':'âœ…','rdv':'ğŸ“…','suivi':'ğŸ”„','dead':'ğŸ’€'};
  container.innerHTML = esnModalLinkedIds.map(id => {
    const c = resolveContactRef(id);
    if (!c) return `
      <div class="esn-linked-ref" style="opacity:0.5;">
        <div class="esn-linked-ref-info"><span style="color:var(--red);">âš ï¸ Contact supprimÃ©</span></div>
        <button class="btn btn-small btn-danger" onclick="unlinkContactRH('${id}')">âœ•</button>
      </div>`;
    return `
      <div class="esn-linked-ref">
        <div class="esn-linked-ref-info">
          <strong>${esc(c.nom)}</strong>${c.role ? ` â€” <span class="ref-role">${esc(c.role)}</span>` : ''}
          <div style="font-size:0.72rem;color:var(--text2);margin-top:2px;">
            ${statusLabels[c.statut] || ''} ${esc(c.entreprise || '')} ${c.email ? `Â· ${esc(c.email)}` : ''}
          </div>
        </div>
        <button class="btn btn-small btn-danger" onclick="unlinkContactRH('${c.id}')">âœ• DÃ©lier</button>
      </div>`;
  }).join('');
}

// Fermer dropdown autocomplete au clic extÃ©rieur
document.addEventListener('click', function(e) {
  const container = document.getElementById('esnLinkContactContainer');
  if (container && !container.contains(e.target) && !e.target.matches('[onclick*="showLinkContactRH"]')) {
    document.getElementById('esnLinkContactDropdown').classList.remove('visible');
  }
});

function saveEsn() {
  const nom = document.getElementById('esnNom').value.trim();
  if (!nom) { toast('âš ï¸ Nom ESN requis', 'var(--orange)'); return; }

  const id = document.getElementById('esnEditId').value;
  const entry = {
    id: id || 'esn-' + crypto.randomUUID().slice(0, 8),
    nom,
    type: document.getElementById('esnType').value,
    priorite: document.getElementById('esnPriorite').value,
    site: document.getElementById('esnSite').value.trim(),
    carrieres: document.getElementById('esnCarrieres').value.trim(),
    ville: document.getElementById('esnVille').value.trim(),
    specialites: document.getElementById('esnSpecialites').value.trim(),
    linkedin: document.getElementById('esnLinkedin').value.trim(),
    contacts: collectContacts(),
    contactRefIds: [...esnModalLinkedIds],
    notes: document.getElementById('esnNotes').value.trim(),
    updatedAt: new Date().toISOString()
  };

  if (id) {
    const idx = esnData.findIndex(e => e.id === id);
    if (idx !== -1) {
      entry.candidatureIds = esnData[idx].candidatureIds || [];
      entry.createdAt = esnData[idx].createdAt;
      esnData[idx] = entry;
    }
  } else {
    entry.candidatureIds = [];
    entry.createdAt = new Date().toISOString();
    esnData.push(entry);
  }

  saveEsnData();
  closeEsnModal();
  toast(id ? 'âœï¸ ESN mise Ã  jour' : 'âœ… ESN ajoutÃ©e');
}

function deleteEsn() {
  const id = document.getElementById('esnEditId').value;
  if (!id || !confirm('Supprimer cette ESN ?')) return;
  esnData = esnData.filter(e => e.id !== id);
  saveEsnData();
  closeEsnModal();
  toast('ğŸ—‘ï¸ ESN supprimÃ©e', 'var(--red)');
}

// SEED DATA â€” auto-load if localStorage is empty
const SEED_DATA = [
  {"id":"hw-reproit","entreprise":"REPRO-IT (Groupe IT & You)","poste":"Technicien Helpdesk informatique et tÃ©lÃ©phonie VoIP","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"https://www.hellowork.com/fr-fr/emplois/74826636.html","salaire":"25K-30K brut/an","notes":"CDI. Carte restaurant + club employÃ©. Support N1/N2, parc info, VoIP.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork"}],"createdAt":"2026-02-20T09:00:00Z","updatedAt":"2026-02-20T10:30:00Z"},
  {"id":"hw-actual-talent","entreprise":"Actual Talent (ex Up Skills)","poste":"Technicien Helpdesk H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"","notes":"CDI. Multi-apply.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork"}],"createdAt":"2026-02-20T10:30:00Z","updatedAt":"2026-02-20T10:30:00Z"},
  {"id":"hw-econocom","entreprise":"Econocom","poste":"Technicien Support Utilisateurs H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"","notes":"CDI. Multi-apply.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork"}],"createdAt":"2026-02-20T10:30:00Z","updatedAt":"2026-02-20T10:30:00Z"},
  {"id":"hw-draks","entreprise":"Draks","poste":"Technicien Support Utilisateurs - Lille H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"","notes":"CDI. Multi-apply.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork"}],"createdAt":"2026-02-20T10:30:00Z","updatedAt":"2026-02-20T10:30:00Z"},
  {"id":"hw-mm-militzer","entreprise":"M&M Militzer & Munch","poste":"Support Informatique Niveau 1 H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Halluin (59)","url":"https://www.hellowork.com/fr-fr/emplois/75397675.html","salaire":"21.9K-31.2K brut/an","notes":"CDI. TÃ©lÃ©travail occasionnel. 13Ã¨me mois, tickets resto, mutuelle, participation, CSE. Secteur transport/logistique.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork avec message personnalisÃ©"}],"createdAt":"2026-02-20T10:40:00Z","updatedAt":"2026-02-20T10:40:00Z"},
  {"id":"hw-helpline-retail","entreprise":"HELPLINE","poste":"Technicien Support Applicatif & ProximitÃ© MÃ©tier Retail H/F","contact":"Isabelle NÃ©ri - Director of Talent Acquisition","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Marcq-en-BarÅ“ul (59)","url":"https://www.hellowork.com/fr-fr/emplois/75874997.html","salaire":"22K-29K brut/an","notes":"CDI. ESN. Support applicatif mÃ©tier Retail. Tickets resto 9.50â‚¬. EMAIL DIRECT envoyÃ© Ã  Isabelle NÃ©ri (Director Talent Acquisition) le 20/02.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork avec message personnalisÃ© Retail"},{"date":"2026-02-20","action":"Email direct Ã  Isabelle NÃ©ri (Director Talent Acquisition)"}],"createdAt":"2026-02-20T10:45:00Z","updatedAt":"2026-02-20T17:51:00Z"},
  {"id":"hw-osmozium","entreprise":"OSMOZIUM","poste":"Technicien Support - Lille - CDI H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"https://www.hellowork.com/fr-fr/emplois/75806838.html","salaire":"21.9K-22.8K brut/an","notes":"CDI. ESN. TÃ©lÃ©travail occasionnel. Support N1 rÃ©seau magasins + siÃ¨ge. Travail 7j/7 roulement.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork avec message personnalisÃ©"}],"createdAt":"2026-02-20T10:50:00Z","updatedAt":"2026-02-20T10:50:00Z"},
  {"id":"hw-securinfor","entreprise":"Securinfor","poste":"Technicien de ProximitÃ© H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Wasquehal (59)","url":"https://www.hellowork.com/fr-fr/emplois/75948855.html","salaire":"22.5K-24K brut/an","notes":"CDI. ESN. Support proximitÃ© N1/N2, gestion parc, ticketing.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork avec message personnalisÃ©"}],"createdAt":"2026-02-20T10:52:00Z","updatedAt":"2026-02-20T10:52:00Z"},
  {"id":"hw-actual-talent-proxi","entreprise":"Actual Talent (ex Up Skills)","poste":"Technicien Support de ProximitÃ© H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"","notes":"CDI. Multi-apply depuis Securinfor.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork multi-apply"}],"createdAt":"2026-02-20T10:53:00Z","updatedAt":"2026-02-20T10:53:00Z"},
  {"id":"hw-astek","entreprise":"Astek","poste":"Technicien Informatique H/F","contact":"","source":"HelloWork","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"","notes":"CDI. TÃ©lÃ©travail partiel. ESN. Multi-apply depuis Securinfor.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via HelloWork multi-apply"}],"createdAt":"2026-02-20T10:53:00Z","updatedAt":"2026-02-20T10:53:00Z"},
  {"id":"indeed-sarbec","entreprise":"Laboratoires Sarbec (Groupe VABEL)","poste":"Technicien Support Informatique H/F","contact":"","source":"Indeed","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Neuville-en-Ferrain (59)","url":"","salaire":"","notes":"CDI. IntÃ©ressement, participation, RTT. Support utilisateurs, maintenance parc. Ã€ 5 min d'Halluin.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via Indeed"}],"createdAt":"2026-02-20T13:00:00Z","updatedAt":"2026-02-20T13:00:00Z"},
  {"id":"indeed-netim","entreprise":"NETIM","poste":"Administrateur SystÃ¨mes et RÃ©seaux Junior H/F","contact":"","source":"Indeed","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"","salaire":"2400-2800â‚¬/mois","notes":"CDI. Proxmox, VMware, Linux, Zabbix, AD, Docker. DÃ©butants acceptÃ©s. PrÃ¨s d'Euratechnologies.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via Indeed"}],"createdAt":"2026-02-20T13:05:00Z","updatedAt":"2026-02-20T13:05:00Z"},
  {"id":"indeed-chevalier","entreprise":"Chevalier","poste":"Technicien Informatique H/F","contact":"","source":"Indeed","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lesquin (59)","url":"","salaire":"27K+ brut/an","notes":"CDI. PME familiale 100 collaborateurs. Support N1/N2, Windows/M365, rÃ©seau. PremiÃ¨re exp acceptÃ©e. RTT, intÃ©ressement.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via Indeed"}],"createdAt":"2026-02-20T13:10:00Z","updatedAt":"2026-02-20T13:10:00Z"},
  {"id":"linkedin-teceze","entreprise":"TECEZE","poste":"IT Support Specialist","contact":"","source":"LinkedIn","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"ArmentiÃ¨res (59)","url":"https://www.linkedin.com/jobs/view/4371168549/","salaire":"","notes":"CDI. Sur site. Support hardware, O365, DHCP/DNS, rÃ©seau L1, datacenter. Candidature simplifiÃ©e LinkedIn.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via LinkedIn Easy Apply"}],"createdAt":"2026-02-20T14:15:00Z","updatedAt":"2026-02-20T14:15:00Z"},
  {"id":"linkedin-ovhcloud","entreprise":"OVHcloud","poste":"Technicien maintenance datacenter H/F/N","contact":"","source":"LinkedIn","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Roubaix (59)","url":"https://www.linkedin.com/jobs/view/4369367053/","salaire":"","notes":"CDI. Sur site. Ã‰quipe 18 techniciens, 3Ã—8h, maintenance hardware serveurs, monitoring. Candidature simplifiÃ©e LinkedIn.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via LinkedIn Easy Apply"}],"createdAt":"2026-02-20T14:20:00Z","updatedAt":"2026-02-20T14:20:00Z"},
  {"id":"linkedin-tekneum-astek","entreprise":"Tekneum by Astek","poste":"Technicien Informatique - Lille H/F","contact":"","source":"LinkedIn","date":"2026-02-20","statut":"envoyee","relanceDate":"2026-02-27","lieu":"Lille (59)","url":"https://www.linkedin.com/jobs/view/4363163760/","salaire":"","notes":"CDI. Hybride. ESN. Support N1/N2/proximitÃ©/VIP, O365, AD, VMware, Centreon/Zabbix. Candidature simplifiÃ©e LinkedIn.","history":[{"date":"2026-02-20","action":"Candidature envoyÃ©e via LinkedIn Easy Apply"}],"createdAt":"2026-02-20T14:25:00Z","updatedAt":"2026-02-20T14:25:00Z"}
];

// === CONTACTS RH MANAGEMENT ===

let contactsData = [];
let contactsFilter = 'all';
let objectifFieldCount = 0;

async function initContactsData() {
  try {
    // Load from contacts-data.json (source of truth, versioned in git)
    let fileContacts = [];
    try {
      const resp = await fetch('contacts-data.json');
      if (resp.ok) fileContacts = await resp.json();
    } catch(e) { console.warn('contacts-data.json non chargÃ©:', e); }

    // Build seed map: file data wins over inline SEED_DATA
    const seedMap = new Map();
    for (const c of CONTACTS_SEED_DATA) seedMap.set(c.id, c);
    for (const c of fileContacts) seedMap.set(c.id, c);
    const mergedSeed = [...seedMap.values()];

    // Load localStorage (has user modifications)
    const localData = JSON.parse(localStorage.getItem('jobtracker-contacts') || '[]');

    if (localData.length > 0) {
      const localIds = new Set(localData.map(c => c.id));
      contactsData = [...localData];
      let added = 0;
      for (const c of mergedSeed) {
        if (!localIds.has(c.id)) {
          contactsData.push(c);
          added++;
        }
      }
      // Update existing entries with seed data if they haven't been modified by user
      for (let i = 0; i < contactsData.length; i++) {
        const seed = seedMap.get(contactsData[i].id);
        if (seed && contactsData[i].updatedAt === seed.updatedAt) {
          contactsData[i] = { ...seed };
        }
      }
      if (added > 0) toast(`ğŸ“¥ ${added} nouveaux contacts RH ajoutÃ©s`);
    } else {
      contactsData = [...mergedSeed];
    }

    saveContactsData();
    renderContactsStats();
    renderContactsGrid();
  } catch(e) {
    console.error('Erreur init contacts:', e);
    contactsData = [...CONTACTS_SEED_DATA];
    saveContactsData();
  }
}

function saveContactsData() {
  try {
    localStorage.setItem('jobtracker-contacts', JSON.stringify(contactsData));
  } catch(e) {
    console.error('Erreur sauvegarde contacts:', e);
  }
}

function renderContactsStats() {
  const total = contactsData.length;
  const aContacter = contactsData.filter(c => c.statut === 'a-contacter').length;
  const contacte = contactsData.filter(c => c.statut === 'contacte').length;
  const rdv = contactsData.filter(c => c.statut === 'rdv').length;
  const urgent = contactsData.filter(c => c.priorite === 'urgent').length;
  
  document.getElementById('contacts-stats-bar').innerHTML = `
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number">${total}</div>
        <div class="stat-label">Total contacts</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:var(--blue)">${aContacter}</div>
        <div class="stat-label">Ã€ contacter</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:var(--green)">${contacte}</div>
        <div class="stat-label">ContactÃ©s</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:var(--accent)">${rdv}</div>
        <div class="stat-label">RDV programmÃ©s</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:var(--red)">${urgent}</div>
        <div class="stat-label">Urgents</div>
      </div>
    </div>
  `;
  
  document.getElementById('tabCountContacts').textContent = total;
}

function setContactsFilter(filter, btn) {
  contactsFilter = filter;
  document.querySelectorAll('[data-contacts-filter]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderContactsGrid();
}

function renderContactsGrid() {
  const search = document.getElementById('contactsSearchInput')?.value.toLowerCase() || '';
  
  let filtered = contactsData.filter(c => {
    const matchesSearch = !search || 
      c.nom.toLowerCase().includes(search) ||
      c.entreprise.toLowerCase().includes(search) ||
      c.role.toLowerCase().includes(search) ||
      c.ville?.toLowerCase().includes(search);
      
    const matchesFilter = contactsFilter === 'all' ||
      (contactsFilter.startsWith('status-') && c.statut === contactsFilter.replace('status-', '')) ||
      (contactsFilter.startsWith('priorite-') && c.priorite === contactsFilter.replace('priorite-', ''));
      
    return matchesSearch && matchesFilter;
  });
  
  const grid = document.getElementById('contactsGrid');
  const emptyState = document.getElementById('contactsEmptyState');
  
  if (filtered.length === 0) {
    grid.innerHTML = '';
    emptyState.style.display = 'flex';
    return;
  }
  
  emptyState.style.display = 'none';
  
  const priorityLabels = {
    urgent: 'ğŸ”´ Urgent',
    important: 'ğŸŸ  Important',
    normal: 'ğŸŸ¡ Normal'
  };
  
  const statusLabels = {
    'a-contacter': 'ğŸ“§ Ã€ contacter',
    'contacte': 'âœ… ContactÃ©',
    'rdv': 'ğŸ“… RDV programmÃ©',
    'suivi': 'ğŸ”„ En suivi',
    'dead': 'ğŸ’€ Dead'
  };
  
  grid.innerHTML = filtered.map(c => {
    const objectifsActifs = (c.objectifs || []).filter(o => !o.termine).length;
    const objectifsTotal = (c.objectifs || []).length;
    
    return `
    <div class="esn-card" onclick="openContactModal('${c.id}')">
      <div class="esn-card-header">
        <div>
          <h3>${esc(c.nom)}</h3>
          <div style="font-size:0.8rem;color:var(--text2);margin-top:2px;">${esc(c.role)} @ ${esc(c.entreprise)}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-direction:column;">
          <span class="esn-priority priority-${c.priorite === 'urgent' ? 'hot' : c.priorite === 'important' ? 'warm' : 'cold'}">${priorityLabels[c.priorite] || c.priorite}</span>
          <span style="font-size:0.68rem;color:var(--text2);background:var(--bg3);padding:2px 8px;border-radius:10px;">${statusLabels[c.statut] || c.statut}</span>
        </div>
      </div>
      
      <div class="esn-contacts" style="margin: 8px 0;">
        ${c.email ? `<div style="font-size:0.8rem;"><a href="mailto:${esc(c.email)}" onclick="event.stopPropagation()" style="color:var(--accent2)">ğŸ“§ ${esc(c.email)}</a></div>` : ''}
        ${c.telephone ? `<div style="font-size:0.8rem;"><a href="tel:${esc(c.telephone)}" onclick="event.stopPropagation()" style="color:var(--accent2)">ğŸ“ ${esc(c.telephone)}</a></div>` : ''}
        ${c.linkedin ? `<div style="font-size:0.8rem;"><a href="${esc(c.linkedin)}" target="_blank" onclick="event.stopPropagation()" style="color:var(--accent2)">ğŸ’¼ LinkedIn</a></div>` : ''}
      </div>
      
      <div class="esn-meta">
        ${c.ville ? `<span class="esn-meta-item">ğŸ“ ${esc(c.ville)}</span>` : ''}
        ${c.source ? `<span class="esn-meta-item">ğŸ” ${esc(c.source)}</span>` : ''}
      </div>
      
      ${objectifsActifs > 0 ? `<div style="background:rgba(99,102,241,0.1);color:var(--accent2);padding:6px 10px;border-radius:6px;font-size:0.75rem;margin:8px 0;">ğŸ¯ ${objectifsActifs}/${objectifsTotal} objectifs actifs</div>` : ''}
      
      ${c.notes ? `<div class="esn-notes">${esc(truncate(c.notes, 100))}</div>` : ''}
    </div>`;
  }).join('');
}

// CONTACT MODAL
function openContactModal(id) {
  const modal = document.getElementById('contactModal');
  const isEdit = !!id;
  document.getElementById('contactModalTitle').textContent = isEdit ? 'Modifier Contact' : 'Nouveau Contact RH';
  document.getElementById('contactDeleteBtn').style.display = isEdit ? 'inline-flex' : 'none';
  objectifFieldCount = 0;

  if (isEdit) {
    const contact = contactsData.find(c => c.id === id);
    if (!contact) return;
    document.getElementById('contactEditId').value = id;
    document.getElementById('contactNom').value = contact.nom || '';
    document.getElementById('contactRole').value = contact.role || '';
    document.getElementById('contactEntreprise').value = contact.entreprise || '';
    document.getElementById('contactVille').value = contact.ville || '';
    document.getElementById('contactEmail').value = contact.email || '';
    document.getElementById('contactTelephone').value = contact.telephone || '';
    document.getElementById('contactLinkedin').value = contact.linkedin || '';
    document.getElementById('contactStatut').value = contact.statut || 'a-contacter';
    document.getElementById('contactPriorite').value = contact.priorite || 'normal';
    document.getElementById('contactSource').value = contact.source || '';
    document.getElementById('contactNotes').value = contact.notes || '';
    // Objectifs
    document.getElementById('objectifsList').innerHTML = '';
    if (contact.objectifs && contact.objectifs.length > 0) {
      contact.objectifs.forEach(o => addObjectifField(o));
    }
  } else {
    document.getElementById('contactEditId').value = '';
    document.getElementById('contactNom').value = '';
    document.getElementById('contactRole').value = '';
    document.getElementById('contactEntreprise').value = '';
    document.getElementById('contactVille').value = '';
    document.getElementById('contactEmail').value = '';
    document.getElementById('contactTelephone').value = '';
    document.getElementById('contactLinkedin').value = '';
    document.getElementById('contactStatut').value = 'a-contacter';
    document.getElementById('contactPriorite').value = 'normal';
    document.getElementById('contactSource').value = '';
    document.getElementById('contactNotes').value = '';
    document.getElementById('objectifsList').innerHTML = '';
  }

  modal.classList.add('active');
  document.getElementById('contactNom').focus();
}

function closeContactModal() { 
  document.getElementById('contactModal').classList.remove('active'); 
}

function addObjectifField(prefill) {
  const idx = objectifFieldCount++;
  const container = document.getElementById('objectifsList');
  const div = document.createElement('div');
  div.className = 'esn-contact';
  div.style.marginBottom = '10px';
  div.innerHTML = `
    <div class="form-row" style="margin-bottom:6px">
      <div class="form-group" style="margin-bottom:0;flex:2"><input type="text" id="objTexte${idx}" placeholder="Ex: Envoyer message LinkedIn, Programmer call, Relancer par email..." value="${esc(prefill?.texte || '')}"></div>
      <div class="form-group" style="margin-bottom:0;flex:1"><input type="date" id="objEcheance${idx}" value="${prefill?.echeance || ''}"></div>
    </div>
    <div class="form-row" style="margin-bottom:6px;align-items:center;">
      <label style="display:flex;align-items:center;font-size:0.8rem;"><input type="checkbox" id="objTermine${idx}" ${prefill?.termine ? 'checked' : ''}> <span style="margin-left:6px;">âœ… TerminÃ©</span></label>
      <button class="btn btn-small btn-danger" onclick="this.parentElement.parentElement.remove()">âœ• Retirer</button>
    </div>
  `;
  container.appendChild(div);
}

function collectObjectifs() {
  const objectifs = [];
  for (let i = 0; i < objectifFieldCount; i++) {
    const texte = document.getElementById(`objTexte${i}`);
    if (!texte) continue; // removed
    const obj = {
      texte: texte.value.trim(),
      echeance: document.getElementById(`objEcheance${i}`)?.value || '',
      termine: document.getElementById(`objTermine${i}`)?.checked || false
    };
    if (obj.texte) objectifs.push(obj);
  }
  return objectifs;
}

function saveContact() {
  const nom = document.getElementById('contactNom').value.trim();
  const entreprise = document.getElementById('contactEntreprise').value.trim();
  if (!nom || !entreprise) { 
    toast('âš ï¸ Nom et entreprise requis', 'var(--orange)'); 
    return; 
  }

  const id = document.getElementById('contactEditId').value;
  const contact = {
    id: id || 'contact-' + crypto.randomUUID().slice(0, 8),
    nom,
    role: document.getElementById('contactRole').value.trim(),
    entreprise,
    ville: document.getElementById('contactVille').value.trim(),
    email: document.getElementById('contactEmail').value.trim(),
    telephone: document.getElementById('contactTelephone').value.trim(),
    linkedin: document.getElementById('contactLinkedin').value.trim(),
    statut: document.getElementById('contactStatut').value,
    priorite: document.getElementById('contactPriorite').value,
    source: document.getElementById('contactSource').value.trim(),
    notes: document.getElementById('contactNotes').value.trim(),
    objectifs: collectObjectifs(),
    updatedAt: new Date().toISOString()
  };

  if (id) {
    const idx = contactsData.findIndex(c => c.id === id);
    if (idx !== -1) {
      contact.createdAt = contactsData[idx].createdAt;
      contactsData[idx] = contact;
    }
  } else {
    contact.createdAt = new Date().toISOString();
    contactsData.push(contact);
  }

  saveContactsData();
  closeContactModal();
  renderContactsStats();
  renderContactsGrid();
  toast(id ? 'âœï¸ Contact mis Ã  jour' : 'âœ… Contact ajoutÃ©');
}

function deleteContact() {
  const id = document.getElementById('contactEditId').value;
  if (!id || !confirm('Supprimer ce contact ?')) return;
  contactsData = contactsData.filter(c => c.id !== id);
  // Nettoyer les rÃ©fÃ©rences dans les ESN
  let cleaned = 0;
  esnData.forEach(e => {
    if (e.contactRefIds && e.contactRefIds.includes(id)) {
      e.contactRefIds = e.contactRefIds.filter(refId => refId !== id);
      cleaned++;
    }
  });
  if (cleaned > 0) saveEsnData();
  saveContactsData();
  closeContactModal();
  renderContactsStats();
  renderContactsGrid();
  toast('ğŸ—‘ï¸ Contact supprimÃ©', 'var(--red)');
}

// SEED DATA CONTACTS RH
const CONTACTS_SEED_DATA = [
  {
    id: 'contact-bruno-vincent-netim',
    nom: 'Bruno VINCENT',
    role: 'CEO & founder',
    entreprise: 'NETIM',
    ville: 'Lille',
    email: 'bruno.vincent@netim.com',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/bruno-vincent-6b5261109',
    statut: 'rdv',
    priorite: 'urgent',
    source: 'Hunter.io + RÃ©ponse reÃ§ue par email',
    notes: 'CEO NETIM qui a rÃ©pondu personnellement ! RÃ‰PONSE ENVOYÃ‰E via Indeed le 20/02/2026. Contact direct excellent Ã©tabli.',
    objectifs: [
      { texte: 'RÃ©pondre Ã  son email via Indeed', echeance: '2026-02-20', termine: true },
      { texte: 'Attendre suite de sa part', echeance: '2026-02-25', termine: false },
      { texte: 'Programmer entretien si suite positive', echeance: '2026-02-27', termine: false }
    ],
    createdAt: '2026-02-20T16:35:00Z',
    updatedAt: '2026-02-20T18:50:00Z'
  },
  {
    id: 'contact-isabelle-neri-helpline',
    nom: 'Isabelle NÃ©ri',
    role: 'Director of Talent Acquisition',
    entreprise: 'HELPLINE',
    ville: 'Marcq-en-BarÅ“ul',
    email: 'isabelle.neri@helpline.fr',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/isabelle-neri',
    statut: 'contacte',
    priorite: 'urgent',
    source: 'Hunter.io',
    notes: 'Directrice recrutement chez HELPLINE (ESN Retail). EMAIL ENVOYÃ‰ le 20/02/2026 avec pitch candidature Support Retail. Professionnel et direct.',
    objectifs: [
      { texte: 'Email de prÃ©sentation candidature Retail', echeance: '2026-02-20', termine: true },
      { texte: 'Relance si pas de rÃ©ponse', echeance: '2026-02-26', termine: false },
      { texte: 'Programmer Ã©change tÃ©lÃ©phonique si rÃ©ponse positive', echeance: '2026-02-28', termine: false }
    ],
    createdAt: '2026-02-20T16:35:00Z',
    updatedAt: '2026-02-20T17:51:00Z'
  },
  {
    id: 'contact-szymon-wroblewski-ovh',
    nom: 'Szymon Wroblewski',
    role: 'Senior Software Engineer (DevOps)',
    entreprise: 'OVHcloud',
    ville: 'Pologne (travaille pour OVH Roubaix)',
    email: 'szymon.wroblewski@ovhcloud.com',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/szymon-wroblewski-67251b59',
    statut: 'contacte',
    priorite: 'important',
    source: 'Hunter.io',
    notes: 'Senior DevOps Engineer chez OVHcloud, basÃ© en Pologne. DEMANDE CONNEXION LINKEDIN envoyÃ©e le 20/02/2026 (message networking/conseil technique). Approche networking, pas candidature directe.',
    objectifs: [
      { texte: 'Demande connexion LinkedIn en anglais', echeance: '2026-02-20', termine: true },
      { texte: 'Attendre acceptation connexion', echeance: '2026-02-25', termine: false },
      { texte: 'Si acceptÃ©: message conseil parcours DevOps', echeance: '2026-02-27', termine: false }
    ],
    createdAt: '2026-02-20T16:35:00Z',
    updatedAt: '2026-02-20T18:01:00Z'
  },
  {
    id: 'contact-fatia-makhloufi-econocom',
    nom: 'Fatia Makhloufi',
    role: 'IT Recruiter & Business Partner',
    entreprise: 'Econocom',
    ville: 'RÃ©gion Est (mais contact backup)',
    email: 'fatia.makhloufi@econocom.com',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/fatia-makhloufi-602350186',
    statut: 'contacte',
    priorite: 'normal',
    source: 'Hunter.io',
    notes: 'IT Recruiter agence Est/Grand Est. DEMANDE CONNEXION LINKEDIN envoyÃ©e le 20/02/2026 (angle networking/Ã©largir rÃ©seau recruteurs IT). Contact backup gÃ©ographique.',
    objectifs: [
      { texte: 'Demande connexion LinkedIn networking', echeance: '2026-02-20', termine: true },
      { texte: 'Attendre acceptation connexion', echeance: '2026-02-27', termine: false },
      { texte: 'Si acceptÃ©e: demander contacts rÃ©gion Nord', echeance: '2026-03-01', termine: false }
    ],
    createdAt: '2026-02-20T16:35:00Z',
    updatedAt: '2026-02-20T18:04:00Z'
  },
  {
    id: 'contact-romain-huot-securinfor',
    nom: 'Romain Huot',
    role: 'Security Infrastructure Administrator',
    entreprise: 'SECURINFOR',
    ville: 'Wasquehal',
    email: 'romain.huot@securinfor.fr',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/romain-huot-7935b3305',
    statut: 'contacte',
    priorite: 'important',
    source: 'Hunter.io',
    notes: 'Admin infra sÃ©curisÃ©es chez SECURINFOR. DEMANDE CONNEXION LINKEDIN envoyÃ©e le 20/02/2026 (networking technique, retour expÃ©rience Ã©quipe). Candidature dÃ©jÃ  envoyÃ©e pour Technicien ProximitÃ©.',
    objectifs: [
      { texte: 'Message LinkedIn networking technique', echeance: '2026-02-20', termine: true },
      { texte: 'Attendre acceptation connexion LinkedIn', echeance: '2026-02-25', termine: false },
      { texte: 'Si acceptÃ©: demander retour expÃ©rience Ã©quipe', echeance: '2026-02-27', termine: false }
    ],
    createdAt: '2026-02-20T18:20:00Z',
    updatedAt: '2026-02-20T18:27:00Z'
  },
  {
    id: 'contact-olivier-trenquier-securinfor',
    nom: 'Olivier Trenquier',
    role: 'Deputy General Manager',
    entreprise: 'SECURINFOR',
    ville: 'Wasquehal',
    email: 'olivier.trenquier@securinfor.fr',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/otrenquier',
    statut: 'a-contacter',
    priorite: 'normal',
    source: 'Hunter.io',
    notes: 'Directeur gÃ©nÃ©ral adjoint SECURINFOR. Contact trop senior pour approche directe candidature technicien. Backup si recommandation via Romain Huot.',
    objectifs: [
      { texte: 'Contact via Romain Huot si opportunitÃ©', echeance: '2026-02-28', termine: false }
    ],
    createdAt: '2026-02-20T18:20:00Z',
    updatedAt: '2026-02-20T18:20:00Z'
  },
  {
    id: 'contact-damien-paquin-securinfor',
    nom: 'Damien Paquin',
    role: 'IT Technician',
    entreprise: 'SECURINFOR',
    ville: 'Wasquehal',
    email: 'damien.paquin@securinfor.fr',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/damien-paquin-3472091b9',
    statut: 'a-contacter',
    priorite: 'normal',
    source: 'Hunter.io',
    notes: 'Technicien informatique SECURINFOR. MÃªme niveau, bon contact networking entre pairs. Backup pour networking technique.',
    objectifs: [
      { texte: 'LinkedIn si pas de rÃ©ponse de Romain', echeance: '2026-02-25', termine: false }
    ],
    createdAt: '2026-02-20T18:20:00Z',
    updatedAt: '2026-02-20T18:20:00Z'
  },
  {
    id: 'contact-olivier-verdier-securinfor',
    nom: 'Olivier Verdier',
    role: 'IT Technician',
    entreprise: 'SECURINFOR',
    ville: 'Wasquehal',
    email: 'olivier.verdier@securinfor.fr',
    telephone: '',
    linkedin: 'https://www.linkedin.com/in/olivier-verdier-22685564',
    statut: 'a-contacter',
    priorite: 'normal',
    source: 'Hunter.io',
    notes: 'Technicien informatique SECURINFOR. MÃªme niveau, contact networking entre pairs. Backup networking.',
    objectifs: [
      { texte: 'LinkedIn si opportunitÃ© networking', echeance: '2026-02-28', termine: false }
    ],
    createdAt: '2026-02-20T18:20:00Z',
    updatedAt: '2026-02-20T18:20:00Z'
  }
];

// === TAB SWITCHING ===

function switchTab(tab, element) {
  // Update active tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (element) element.classList.add('active');
  
  // Update active section
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(`section-${tab}`).classList.add('active');
  
  // Render appropriate content
  if (tab === 'candidatures') {
    renderStats();
    renderTable();
  } else if (tab === 'esn') {
    renderEsnStats();
    renderEsnGrid();
  } else if (tab === 'contacts') {
    renderContactsStats();
    renderContactsGrid();
  }
}

// INIT â€” load data then try to restore file handle
initData().then(async () => {
  restoreFileHandle();
  await initEsnData();
  await initContactsData();
});
</script>

</body>
</html>
